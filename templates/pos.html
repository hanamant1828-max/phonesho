<!doctype html>
<html lang="en">
    <head>
        <meta charset="UTF-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <title>Point of Sale - Mobile Shop Manager</title>

        <!-- Bootstrap CSS -->
        <link
            href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css"
            rel="stylesheet"
        />
        <link
            rel="stylesheet"
            href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css"
        />

        <!-- Google Fonts -->
        <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">

        <style>
            :root {
                --primary-color: #1E6FFF;
                --primary-dark: #1557D6;
                --success-color: #10B981;
                --success-dark: #059669;
                --danger-color: #EF4444;
                --warning-color: #F59E0B;
                --gray-50: #F9FAFB;
                --gray-100: #F3F4F6;
                --gray-200: #E6E9EF;
                --gray-300: #D1D5DB;
                --gray-400: #9CA3AF;
                --gray-500: #6B7280;
                --gray-600: #4B5563;
                --gray-700: #374151;
                --gray-800: #1F2937;
                --gray-900: #111827;
                --shadow-sm: 0 1px 2px 0 rgba(0, 0, 0, 0.05);
                --shadow-md: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
                --shadow-lg: 0 6px 20px rgba(16, 24, 40, 0.06);
                --border-radius: 8px;
                --border-radius-lg: 12px;
            }

            * {
                margin: 0;
                padding: 0;
                box-sizing: border-box;
            }

            body {
                background: var(--gray-50);
                font-family: 'Inter', -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
                min-height: 100vh;
                color: var(--gray-900);
            }

            /* Header */
            .pos-header {
                background: white;
                border-bottom: 1px solid var(--gray-200);
                padding: 12px 24px;
                box-shadow: var(--shadow-sm);
                position: sticky;
                top: 0;
                z-index: 1000;
            }

            .pos-header .header-content {
                display: flex;
                justify-content: space-between;
                align-items: center;
                max-width: 1920px;
                margin: 0 auto;
            }

            .header-left {
                display: flex;
                align-items: center;
                gap: 16px;
            }

            .app-logo {
                width: 36px;
                height: 36px;
                background: var(--primary-color);
                border-radius: 8px;
                display: flex;
                align-items: center;
                justify-content: center;
                color: white;
                font-weight: 700;
                font-size: 18px;
            }

            .app-title {
                font-size: 18px;
                font-weight: 700;
                color: var(--gray-900);
            }

            .header-actions {
                display: flex;
                gap: 8px;
            }

            /* Transaction Type Tabs */
            .transaction-tabs {
                display: flex;
                gap: 4px;
                background: var(--gray-100);
                padding: 4px;
                border-radius: var(--border-radius);
                width: fit-content;
                margin: 0 auto;
            }

            .transaction-tab {
                padding: 8px 20px;
                border: none;
                background: transparent;
                color: var(--gray-600);
                font-weight: 600;
                font-size: 14px;
                cursor: pointer;
                border-radius: 6px;
                transition: all 0.16s ease;
                display: flex;
                align-items: center;
                gap: 6px;
            }

            .transaction-tab:hover {
                color: var(--primary-color);
                background: var(--gray-50);
            }

            .transaction-tab.active {
                color: white;
                background: var(--primary-color);
                box-shadow: var(--shadow-sm);
            }

            /* Main Container */
            .pos-main {
                display: flex;
                height: calc(100vh - 73px);
                max-width: 1920px;
                margin: 0 auto;
            }

            /* Category Sidebar */
            .category-sidebar {
                width: 80px;
                background: #f5f5f5;
                border-right: 1px solid var(--gray-200);
                display: flex;
                flex-direction: column;
                transition: width 0.3s ease;
                overflow: hidden;
                z-index: 100;
            }

            .category-sidebar.expanded {
                width: 280px;
            }

            .category-main-btn {
                width: 100%;
                padding: 20px 12px;
                background: var(--primary-color);
                color: white;
                border: none;
                cursor: pointer;
                display: flex;
                flex-direction: column;
                align-items: center;
                gap: 8px;
                font-size: 14px;
                font-weight: 600;
                transition: all 0.3s ease;
                border-bottom: 2px solid rgba(0, 0, 0, 0.1);
            }

            .category-main-btn:hover {
                background: var(--primary-dark);
            }

            .category-main-btn i {
                font-size: 24px;
            }

            .category-sidebar.expanded .category-main-btn {
                flex-direction: row;
                justify-content: center;
                padding: 20px;
            }

            .category-list {
                display: none;
                flex-direction: column;
                gap: 12px;
                padding: 16px 12px;
                overflow-y: auto;
            }

            .category-sidebar.expanded .category-list {
                display: flex;
            }

            .category-sidebar.expanded .category-search-container {
                display: block !important;
            }

            .category-search-container input {
                width: 100%;
                border: 1px solid var(--gray-300);
                border-radius: 6px;
                font-size: 13px;
            }

            .category-search-container input:focus {
                outline: none;
                border-color: var(--primary-color);
                box-shadow: 0 0 0 3px rgba(30, 111, 255, 0.1);
            }

            .category-btn {
                width: 100%;
                padding: 18px 20px;
                background: #d1d5db;
                color: white;
                border: none;
                border-radius: 16px;
                cursor: pointer;
                font-size: 15px;
                font-weight: 600;
                text-align: center;
                transition: all 0.2s ease;
                box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
                white-space: nowrap;
                overflow: hidden;
                text-overflow: ellipsis;
            }

            .category-btn:hover {
                background: #9ca3af;
                transform: translateY(-2px);
                box-shadow: 0 4px 8px rgba(0, 0, 0, 0.15);
            }

            .category-btn.active {
                background: var(--primary-color);
                box-shadow: 0 4px 12px rgba(30, 111, 255, 0.3);
            }

            /* Left Panel */
            .left-panel {
                flex: 1;
                display: flex;
                flex-direction: column;
                background: white;
                overflow: hidden;
            }

            /* Search Section */
            .search-section {
                padding: 24px;
                border-bottom: 1px solid var(--gray-200);
                background: white;
            }

            .search-box {
                position: relative;
                max-width: 720px;
                margin: 0 auto;
            }

            .search-box input {
                width: 100%;
                padding: 14px 48px 14px 48px;
                font-size: 15px;
                border: 2px solid var(--gray-200);
                border-radius: var(--border-radius-lg);
                transition: all 0.16s ease;
                background: var(--gray-50);
            }

            .search-box input:focus {
                outline: none;
                border-color: var(--primary-color);
                background: white;
                box-shadow: 0 0 0 4px rgba(30, 111, 255, 0.1);
            }

            .search-box .search-icon {
                position: absolute;
                left: 16px;
                top: 50%;
                transform: translateY(-50%);
                font-size: 20px;
                color: var(--gray-400);
            }

            .search-box .scan-btn {
                position: absolute;
                right: 8px;
                top: 50%;
                transform: translateY(-50%);
                background: var(--primary-color);
                color: white;
                border: none;
                padding: 6px 12px;
                border-radius: 6px;
                font-size: 13px;
                font-weight: 600;
                cursor: pointer;
                transition: all 0.16s ease;
            }

            .search-box .scan-btn:hover {
                background: var(--primary-dark);
            }

            /* Search Results */
            .search-results {
                max-height: 320px;
                overflow-y: auto;
                padding: 0 24px 24px;
            }

            .product-result {
                display: flex;
                align-items: center;
                gap: 16px;
                background: white;
                border: 1px solid var(--gray-200);
                border-radius: var(--border-radius);
                padding: 12px;
                margin-bottom: 8px;
                cursor: pointer;
                transition: all 0.16s ease;
            }

            .product-result:hover {
                border-color: var(--primary-color);
                box-shadow: var(--shadow-md);
                transform: translateY(-1px);
            }

            .product-result img {
                width: 56px;
                height: 56px;
                object-fit: cover;
                border-radius: 8px;
                background: var(--gray-100);
            }

            .product-info {
                flex: 1;
            }

            .product-name {
                font-weight: 600;
                color: var(--gray-900);
                margin-bottom: 4px;
                font-size: 14px;
            }

            .product-meta {
                font-size: 12px;
                color: var(--gray-500);
            }

            .product-price {
                font-size: 18px;
                font-weight: 700;
                color: var(--success-color);
            }

            .stock-badge {
                padding: 4px 10px;
                border-radius: 12px;
                font-size: 11px;
                font-weight: 600;
            }

            .stock-badge.in-stock {
                background: #D1FAE5;
                color: #065F46;
            }

            .stock-badge.out-of-stock {
                background: #FEE2E2;
                color: #991B1B;
            }

            /* Cart Section */
            .cart-section {
                flex: 1;
                overflow-y: auto;
                padding: 24px;
                background: var(--gray-50);
            }

            .cart-header {
                display: flex;
                justify-content: space-between;
                align-items: center;
                margin-bottom: 16px;
            }

            .cart-title {
                font-size: 16px;
                font-weight: 700;
                color: var(--gray-900);
                display: flex;
                align-items: center;
                gap: 8px;
            }

            .cart-count {
                background: var(--primary-color);
                color: white;
                padding: 2px 8px;
                border-radius: 12px;
                font-size: 12px;
                font-weight: 600;
            }

            .cart-item {
                background: white;
                border: 1px solid var(--gray-200);
                border-radius: var(--border-radius);
                padding: 16px;
                margin-bottom: 12px;
                box-shadow: var(--shadow-sm);
                transition: all 0.16s ease;
            }

            .cart-item:hover {
                box-shadow: var(--shadow-md);
            }

            .cart-item-header {
                display: flex;
                justify-content: space-between;
                margin-bottom: 12px;
            }

            .cart-item-name {
                font-weight: 600;
                color: var(--gray-900);
                font-size: 14px;
            }

            .cart-item-sku {
                font-size: 12px;
                color: var(--gray-500);
                margin-top: 2px;
            }

            .cart-item-controls {
                display: flex;
                justify-content: space-between;
                align-items: center;
                margin-bottom: 12px;
            }

            .cart-item-discount {
                display: flex;
                align-items: center;
                gap: 8px;
                margin-top: 8px;
                padding: 8px;
                background: var(--gray-50);
                border-radius: 8px;
            }

            .cart-item-discount label {
                font-size: 12px;
                font-weight: 600;
                color: var(--gray-600);
                margin: 0;
            }

            .cart-item-discount input {
                width: 80px;
                padding: 6px 8px;
                border: 1px solid var(--gray-300);
                border-radius: 6px;
                font-size: 13px;
            }

            .cart-item-discount input:focus {
                outline: none;
                border-color: var(--primary-color);
                box-shadow: 0 0 0 3px rgba(30, 111, 255, 0.1);
            }

            .qty-control {
                display: flex;
                align-items: center;
                gap: 8px;
                background: var(--gray-50);
                padding: 4px;
                border-radius: 8px;
            }

            .qty-btn {
                width: 32px;
                height: 32px;
                border-radius: 6px;
                border: none;
                background: white;
                color: var(--gray-700);
                font-weight: 600;
                cursor: pointer;
                transition: all 0.16s ease;
                display: flex;
                align-items: center;
                justify-content: center;
                box-shadow: var(--shadow-sm);
            }

            .qty-btn:hover {
                background: var(--primary-color);
                color: white;
            }

            .qty-value {
                font-weight: 700;
                color: var(--gray-900);
                min-width: 32px;
                text-align: center;
                font-size: 14px;
            }

            .cart-item-price {
                text-align: right;
            }

            .cart-item-unit-price {
                font-size: 12px;
                color: var(--gray-500);
            }

            .cart-item-total {
                font-size: 16px;
                font-weight: 700;
                color: var(--success-color);
            }

            /* IMEI Section */
            .imei-section {
                padding: 12px;
                background: var(--gray-50);
                border-radius: 8px;
                border: 1px solid var(--gray-200);
            }

            .imei-header {
                display: flex;
                justify-content: space-between;
                align-items: center;
                margin-bottom: 8px;
            }

            .imei-label {
                font-size: 13px;
                font-weight: 600;
                color: var(--gray-700);
            }

            .imei-status {
                padding: 2px 8px;
                border-radius: 6px;
                font-size: 11px;
                font-weight: 600;
            }

            .imei-status.complete {
                background: #D1FAE5;
                color: #065F46;
            }

            .imei-status.incomplete {
                background: #FEF3C7;
                color: #991B1B;
            }

            .imei-input-group {
                display: flex;
                gap: 8px;
            }

            .imei-input {
                flex: 1;
                padding: 8px 12px;
                border: 1px solid var(--gray-300);
                border-radius: 6px;
                font-family: "Courier New", monospace;
                font-size: 13px;
            }

            .imei-input:focus {
                outline: none;
                border-color: var(--primary-color);
                box-shadow: 0 0 0 3px rgba(30, 111, 255, 0.1);
            }

            .imei-add-btn {
                padding: 8px 16px;
                background: var(--primary-color);
                color: white;
                border: none;
                border-radius: 6px;
                font-weight: 600;
                cursor: pointer;
                transition: all 0.16s ease;
                font-size: 13px;
            }

            .imei-add-btn:hover {
                background: var(--primary-dark);
            }

            .imei-list {
                margin-top: 8px;
                display: flex;
                flex-wrap: wrap;
                gap: 6px;
            }

            .imei-tag {
                display: inline-flex;
                align-items: center;
                gap: 6px;
                padding: 6px 10px;
                background: white;
                border: 1px solid var(--gray-200);
                border-radius: 6px;
                font-family: "Courier New", monospace;
                font-size: 11px;
            }

            .imei-tag button {
                background: none;
                border: none;
                color: var(--danger-color);
                cursor: pointer;
                padding: 0;
                display: flex;
                align-items: center;
            }

            .empty-cart {
                text-align: center;
                padding: 64px 24px;
                color: var(--gray-500);
            }

            .empty-cart i {
                font-size: 64px;
                margin-bottom: 16px;
                color: var(--gray-300);
            }

            /* Right Panel */
            .right-panel {
                width: 420px;
                background: white;
                border-left: 1px solid var(--gray-200);
                display: flex;
                flex-direction: column;
                overflow-y: auto;
            }

            .billing-section {
                padding: 24px;
                border-bottom: 1px solid var(--gray-200);
            }

            .section-title {
                font-size: 14px;
                font-weight: 700;
                color: var(--gray-900);
                margin-bottom: 16px;
                display: flex;
                align-items: center;
                gap: 8px;
            }

            .form-group {
                margin-bottom: 16px;
            }

            .form-label {
                font-size: 13px;
                font-weight: 600;
                color: var(--gray-700);
                margin-bottom: 6px;
                display: block;
            }

            .form-input {
                width: 100%;
                padding: 10px 12px;
                border: 1px solid var(--gray-300);
                border-radius: var(--border-radius);
                font-size: 14px;
                transition: all 0.16s ease;
            }

            .form-input:focus {
                outline: none;
                border-color: var(--primary-color);
                box-shadow: 0 0 0 3px rgba(30, 111, 255, 0.1);
            }

            /* Summary */
            .summary-row {
                display: flex;
                justify-content: space-between;
                align-items: center;
                margin-bottom: 12px;
                font-size: 14px;
            }

            .summary-label {
                color: var(--gray-600);
                font-weight: 500;
            }

            .summary-value {
                font-weight: 700;
                color: var(--gray-900);
            }

            .summary-row.discount .summary-value {
                color: var(--danger-color);
            }

            .summary-row.tax .summary-value {
                color: var(--gray-700);
            }

            .summary-row.total {
                padding-top: 16px;
                border-top: 2px solid var(--gray-200);
                margin-top: 8px;
            }

            .summary-row.total .summary-label {
                font-size: 16px;
                font-weight: 700;
                color: var(--gray-900);
            }

            .summary-row.total .summary-value {
                font-size: 24px;
                color: var(--success-color);
            }

            .input-group {
                display: flex;
                align-items: center;
                gap: 8px;
            }

            .input-group input {
                width: 70px;
            }

            /* Buttons */
            .btn {
                padding: 12px 20px;
                border-radius: var(--border-radius);
                font-weight: 600;
                cursor: pointer;
                transition: all 0.16s ease;
                border: none;
                display: inline-flex;
                align-items: center;
                justify-content: center;
                gap: 8px;
                font-size: 14px;
            }

            .btn-primary {
                background: var(--primary-color);
                color: white;
            }

            .btn-primary:hover {
                background: var(--primary-dark);
                transform: translateY(-1px);
                box-shadow: var(--shadow-md);
            }

            .btn-success {
                background: var(--success-color);
                color: white;
                width: 100%;
                padding: 16px;
                font-size: 16px;
            }

            .btn-success:hover {
                background: var(--success-dark);
                transform: translateY(-1px);
                box-shadow: 0 10px 15px -3px rgba(16, 185, 129, 0.3);
            }

            .btn-danger {
                background: var(--danger-color);
                color: white;
                padding: 8px 16px;
                font-size: 13px;
            }

            .btn-danger:hover {
                background: #DC2626;
            }

            .btn-outline {
                background: white;
                color: var(--gray-700);
                border: 1px solid var(--gray-300);
                padding: 8px 16px;
                font-size: 13px;
            }

            .btn-outline:hover {
                background: var(--gray-50);
                border-color: var(--gray-400);
            }

            .btn-icon {
                width: 36px;
                height: 36px;
                padding: 0;
                border-radius: 8px;
            }

            /* Select */
            .form-select {
                width: 100%;
                padding: 12px;
                border: 1px solid var(--gray-300);
                border-radius: var(--border-radius);
                font-size: 14px;
                font-weight: 600;
                cursor: pointer;
                transition: all 0.16s ease;
            }

            .form-select:focus {
                outline: none;
                border-color: var(--primary-color);
                box-shadow: 0 0 0 3px rgba(30, 111, 255, 0.1);
            }

            /* Scrollbar */
            ::-webkit-scrollbar {
                width: 8px;
            }

            ::-webkit-scrollbar-track {
                background: var(--gray-100);
            }

            ::-webkit-scrollbar-thumb {
                background: var(--gray-300);
                border-radius: 4px;
            }

            ::-webkit-scrollbar-thumb:hover {
                background: var(--gray-400);
            }

            /* Responsive */
            @media (max-width: 1024px) {
                .right-panel {
                    width: 360px;
                }
            }

            @media (max-width: 768px) {
                .pos-main {
                    flex-direction: column;
                    height: auto;
                }

                .right-panel {
                    width: 100%;
                }

                .category-sidebar {
                    width: 60px;
                }

                .category-sidebar.expanded {
                    position: fixed;
                    left: 0;
                    top: 73px;
                    height: calc(100vh - 73px);
                    width: 250px;
                    z-index: 1000;
                    box-shadow: 2px 0 10px rgba(0, 0, 0, 0.1);
                }

                .category-main-btn span {
                    display: none;
                }

                .category-sidebar.expanded .category-main-btn span {
                    display: block;
                }
            }
        </style>
    </head>
    <body>
        <!-- Header -->
        <div class="pos-header">
            <div class="header-content">
                <div class="header-left">
                    <div class="app-logo">
                        <i class="bi bi-shop"></i>
                    </div>
                    <div>
                        <div class="app-title">Point of Sale</div>
                    </div>
                    <div class="transaction-tabs">
                        <button
                            class="transaction-tab active"
                            data-type="sale"
                            onclick="selectTransactionType('sale', this)"
                        >
                            <i class="bi bi-cart-check-fill"></i> Sale
                        </button>
                        <button
                            class="transaction-tab"
                            data-type="return"
                            onclick="selectTransactionType('return', this)"
                        >
                            <i class="bi bi-arrow-counterclockwise"></i> Return
                        </button>
                        <button
                            class="transaction-tab"
                            data-type="exchange"
                            onclick="selectTransactionType('exchange', this)"
                        >
                            <i class="bi bi-arrow-left-right"></i> Exchange
                        </button>
                    </div>
                </div>
                <div class="header-actions">
                    <button
                        class="btn btn-outline"
                        onclick="window.location.href='/'"
                    >
                        <i class="bi bi-arrow-left"></i> Dashboard
                    </button>
                </div>
            </div>
        </div>

        <!-- Main Content -->
        <div class="pos-main">
            <!-- Category Sidebar -->
            <div class="category-sidebar" id="categorySidebar">
                <button class="category-main-btn" id="categoryMainBtn">
                    <i class="bi bi-grid-3x3-gap-fill"></i>
                    <span>Category</span>
                </button>
                <div class="category-search-container" style="padding: 12px; display: none;">
                    <input type="text" class="form-control form-control-sm" id="categorySearchInput" placeholder="Search categories...">
                </div>
                <div class="category-list" id="categoryList"></div>
            </div>

            <!-- Left Panel -->
            <div class="left-panel">
                <!-- Category Selection -->
                <div class="search-section" style="padding-bottom: 12px; border-bottom: none; display: none;">
                    <div class="search-box" style="max-width: 720px; margin: 0 auto;">
                        <label style="display: block; margin-bottom: 8px; font-weight: 600; color: var(--gray-700); font-size: 14px;">
                            <i class="bi bi-tag-fill"></i> Select Category
                        </label>
                        <select id="categorySelect" class="form-select" style="width: 100%; padding: 12px 16px; font-size: 15px; border: 2px solid var(--gray-200); border-radius: var(--border-radius-lg); transition: all 0.16s ease; background: var(--gray-50);">
                            <option value="">-- Select a category first --</option>
                        </select>
                    </div>
                </div>

                <!-- Search -->
                <div class="search-section" style="padding-top: 12px;">
                    <div class="search-box">
                        <i class="bi bi-search search-icon"></i>
                        <input
                            type="text"
                            id="productSearch"
                            placeholder="Select a category first to search products..."
                            disabled
                        />
                        <button class="scan-btn" disabled>
                            <i class="bi bi-upc-scan"></i> Scan
                        </button>
                    </div>
                </div>

                <!-- Search Results -->
                <div class="search-results" id="searchResults"></div>

                <!-- Cart -->
                <div class="cart-section">
                    <div class="cart-header">
                        <div class="cart-title">
                            <i class="bi bi-cart3"></i> Cart
                            <span class="cart-count" id="cartCount">0</span>
                        </div>
                        <button class="btn btn-outline" onclick="clearCart()">
                            <i class="bi bi-trash"></i> Clear
                        </button>
                    </div>
                    <div id="cartItems">
                        <div class="empty-cart">
                            <i class="bi bi-cart-x"></i>
                            <h5>Cart is empty</h5>
                            <p>Search and add products to start billing</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Right Panel -->
            <div class="right-panel">
                <!-- Customer Information -->
                <div class="billing-section">
                    <div class="section-title">
                        <i class="bi bi-person-circle"></i> Customer Information
                    </div>
                    <div class="form-group">
                        <label class="form-label">Customer Name</label>
                        <input
                            type="text"
                            id="customerName"
                            class="form-input"
                            placeholder="Enter customer name (optional)"
                        />
                    </div>
                    <div class="form-group">
                        <label class="form-label">Phone Number</label>
                        <input
                            type="tel"
                            id="customerPhone"
                            class="form-input"
                            placeholder="Enter phone number (optional)"
                        />
                    </div>
                    <div class="form-group">
                        <label class="form-label">Email Address</label>
                        <input
                            type="email"
                            id="customerEmail"
                            class="form-input"
                            placeholder="Enter email address (optional)"
                        />
                    </div>
                </div>

                <!-- Bill Summary -->
                <div class="billing-section" style="flex: 1">
                    <div class="section-title">
                        <i class="bi bi-receipt"></i> Bill Summary
                    </div>

                    <div id="itemBreakdown">
                        <!-- Per-item breakdown will be loaded here -->
                    </div>

                    <div class="summary-row">
                        <span class="summary-label">Subtotal</span>
                        <span class="summary-value" id="subtotal">â‚¹0.00</span>
                    </div>

                    <div class="summary-row">
                        <div class="input-group">
                            <span class="summary-label">Discount</span>
                            <input
                                type="number"
                                id="discountPercent"
                                class="form-input"
                                value="0"
                                min="0"
                                max="100"
                                step="0.1"
                                onchange="calculateTotals()"
                            />
                            <span class="summary-label">%</span>
                        </div>
                        <span class="summary-value discount" id="discountAmount">-â‚¹0.00</span>
                    </div>

                    <div class="summary-row">
                        <div class="input-group">
                            <span class="summary-label">Tax</span>
                            <input
                                type="number"
                                id="taxPercent"
                                class="form-input"
                                value="0"
                                min="0"
                                max="100"
                                step="0.1"
                                onchange="calculateTotals()"
                            />
                            <span class="summary-label">%</span>
                        </div>
                        <span class="summary-value tax" id="taxAmount">+â‚¹0.00</span>
                    </div>

                    <div class="summary-row total">
                        <span class="summary-label">Total Amount</span>
                        <span class="summary-value" id="total">â‚¹0.00</span>
                    </div>
                </div>

                <!-- Payment & Checkout -->
                <div class="billing-section">
                    <div class="form-group">
                        <label class="form-label">Payment Method</label>
                        <select class="form-select" id="paymentMethod">
                            <option value="cash">ðŸ’µ Cash</option>
                            <option value="card">ðŸ’³ Card</option>
                            <option value="upi">ðŸ“± UPI</option>
                            <option value="wallet">ðŸ‘› Wallet</option>
                        </select>
                    </div>

                    <div class="d-grid gap-2">
                        <button class="btn btn-success" onclick="completeSale(false)">
                            <i class="bi bi-check-circle-fill"></i> Complete Sale
                        </button>
                        <button class="btn btn-primary" onclick="completeSale(true)">
                            <i class="bi bi-printer-fill"></i> Save and Print
                        </button>
                        
                        <!-- New Action Buttons -->
                        <div class="row g-2 mt-2">
                            <div class="col-6">
                                <button class="btn btn-warning w-100" onclick="holdBill()">
                                    <i class="bi bi-pause-circle"></i> Hold Bill
                                </button>
                            </div>
                            <div class="col-6">
                                <button class="btn btn-info w-100" onclick="showResumeBillModal()">
                                    <i class="bi bi-play-circle"></i> Resume Bill
                                </button>
                            </div>
                        </div>
                        <div class="row g-2 mb-2">
                            <div class="col-6">
                                <button class="btn btn-outline-primary w-100" onclick="saveBillDraft()">
                                    <i class="bi bi-save"></i> Save Bill
                                </button>
                            </div>
                            <div class="col-6">
                                <button class="btn btn-outline-info w-100" onclick="showSavedBillsModal()">
                                    <i class="bi bi-folder-open"></i> View Saved
                                </button>
                            </div>
                        </div>
                        <div class="row g-2">
                            <div class="col-12">
                                <button class="btn btn-outline-success w-100" onclick="shareViaWhatsApp()">
                                    <i class="bi bi-whatsapp"></i> Share via WhatsApp
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- IMEI Selection Modal -->
        <div class="modal fade" id="imeiSelectionModal" tabindex="-1">
            <div class="modal-dialog modal-lg">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title"><i class="bi bi-upc-scan"></i> Select IMEI Numbers from Inventory</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                    </div>
                    <div class="modal-body">
                        <div class="alert alert-info">
                            <strong>Product:</strong> <span id="imeiProductName"></span><br>
                            <strong>Quantity Required:</strong> <span id="imeiQuantityRequired"></span>
                        </div>
                        <div class="table-responsive">
                            <table class="table table-hover">
                                <thead>
                                    <tr>
                                        <th width="50">Select</th>
                                        <th>IMEI Number</th>
                                        <th>Status</th>
                                    </tr>
                                </thead>
                                <tbody id="imeiSelectionList"></tbody>
                            </table>
                        </div>
                        <div id="imeiSelectionError" class="alert alert-danger" style="display:none;"></div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                        <button type="button" class="btn btn-primary" id="confirmImeiSelectionBtn">Confirm Selection</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Resume Bill Modal -->
        <div class="modal fade" id="resumeBillModal" tabindex="-1">
            <div class="modal-dialog modal-lg">
                <div class="modal-content">
                    <div class="modal-header bg-info text-white">
                        <h5 class="modal-title"><i class="bi bi-play-circle"></i> Resume Held Bills</h5>
                        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                    </div>
                    <div class="modal-body">
                        <div id="heldBillsList">
                            <!-- Held bills will be loaded here -->
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Saved Bills Modal -->
        <div class="modal fade" id="savedBillsModal" tabindex="-1" aria-labelledby="savedBillsModalLabel" aria-hidden="true">
            <div class="modal-dialog modal-xl modal-dialog-scrollable">
                <div class="modal-content">
                    <div class="modal-header" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white;">
                        <h5 class="modal-title" id="savedBillsModalLabel">
                            <i class="bi bi-folder-open"></i> Saved Bills
                        </h5>
                        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>
                    <div class="modal-body" style="background: #f8f9fa;">
                        <div id="savedBillsList">
                            <!-- Saved bills will be loaded here -->
                        </div>
                    </div>
                    <div class="modal-footer" style="background: white;">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                            <i class="bi bi-x-circle"></i> Close
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Bootstrap JS -->
        <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
        <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

        <script>
            const API_BASE = "/api";
            let cart = []; // Changed from cartItems to cart for consistency with the context
            let currentTransactionType = "sale";
            let searchTimeout = null;
            let currentCartIndexForIMEI = null;
            let selectedCategoryId = "";

            // Load categories on page load
            function loadCategories() {
                $.get(`${API_BASE}/categories`, function(categories) {
                    const select = $('#categorySelect');
                    select.empty();
                    select.append('<option value="">-- Select a category first --</option>');
                    select.append('<option value="all">All Categories</option>');

                    const categoryList = $('#categoryList');
                    categoryList.empty();

                    // Add "All Categories" button
                    categoryList.append(`
                        <button class="category-btn" data-category-id="all">
                            All Categories
                        </button>
                    `);

                    categories.forEach(cat => {
                        select.append(`<option value="${cat.id}">${cat.name}</option>`);

                        // Add category button to sidebar
                        categoryList.append(`
                            <button class="category-btn" data-category-id="${cat.id}">
                                ${cat.name}
                            </button>
                        `);
                    });

                    // Attach click handlers to category buttons
                    $('.category-btn').on('click', function() {
                        const categoryId = $(this).data('category-id');
                        selectCategory(categoryId, $(this));
                    });
                }).fail(function() {
                    alert('Error loading categories');
                });
            }

            // Toggle sidebar expansion
            $('#categoryMainBtn').on('click', function() {
                $('#categorySidebar').toggleClass('expanded');
                if ($('#categorySidebar').hasClass('expanded')) {
                    setTimeout(() => {
                        $('#categorySearchInput').focus();
                    }, 100);
                }
            });

            // Category search functionality
            $('#categorySearchInput').on('input', function() {
                const searchTerm = $(this).val().toLowerCase().trim();
                $('.category-btn').each(function() {
                    const categoryName = $(this).text().toLowerCase();
                    if (categoryName.includes(searchTerm)) {
                        $(this).show();
                    } else {
                        $(this).hide();
                    }
                });
            });

            // Select category from sidebar
            function selectCategory(categoryId, buttonElement) {
                selectedCategoryId = categoryId;
                const $searchInput = $('#productSearch');
                const $scanBtn = $('.scan-btn');

                // Update active state
                $('.category-btn').removeClass('active');
                buttonElement.addClass('active');

                // Enable search
                $searchInput.prop('disabled', false);
                $searchInput.attr('placeholder', 'Search product name, SKU or scan barcode...');
                $searchInput.css('background', 'var(--gray-50)');
                $scanBtn.prop('disabled', false);

                // Load products for selected category
                loadProductsByCategory(selectedCategoryId);

                // Collapse sidebar on mobile
                if (window.innerWidth < 768) {
                    $('#categorySidebar').removeClass('expanded');
                }
            }

            // Category selection handler (keeping for backward compatibility)
            $('#categorySelect').on('change', function() {
                selectedCategoryId = $(this).val();
                const $searchInput = $('#productSearch');
                const $scanBtn = $('.scan-btn');

                if (selectedCategoryId) {
                    // Enable search
                    $searchInput.prop('disabled', false);
                    $searchInput.attr('placeholder', 'Search product name, SKU or scan barcode...');
                    $searchInput.css('background', 'var(--gray-50)');
                    $scanBtn.prop('disabled', false);

                    // Load products for selected category
                    loadProductsByCategory(selectedCategoryId);
                } else {
                    // Disable search
                    $searchInput.prop('disabled', true);
                    $searchInput.attr('placeholder', 'Select a category first to search products...');
                    $searchInput.css('background', '#f3f4f6');
                    $searchInput.val('');
                    $scanBtn.prop('disabled', true);
                    $('#searchResults').empty();
                }
            });

            // Load products by category
            function loadProductsByCategory(categoryId) {
                $.get(
                    `${API_BASE}/pos/products/by-category?category_id=${encodeURIComponent(categoryId)}`,
                    function (products) {
                        displaySearchResults(products);
                    }
                ).fail(function () {
                    $("#searchResults").html(
                        '<div class="text-center text-muted py-3">Error loading products</div>',
                    );
                });
            }

            // Product Search
            $("#productSearch").on("input", function () {
                clearTimeout(searchTimeout);
                const query = $(this).val().trim();

                if (!selectedCategoryId) {
                    return;
                }

                if (query.length < 2) {
                    // If search is cleared, show category products again
                    loadProductsByCategory(selectedCategoryId);
                    return;
                }

                searchTimeout = setTimeout(() => {
                    searchProducts(query);
                }, 300);
            });

            function searchProducts(query) {
                const categoryParam = selectedCategoryId ? `&category_id=${encodeURIComponent(selectedCategoryId)}` : '';
                $.get(
                    `${API_BASE}/pos/products/search?q=${encodeURIComponent(query)}${categoryParam}`,
                    function (products) {
                        displaySearchResults(products);
                    },
                ).fail(function () {
                    $("#searchResults").html(
                        '<div class="text-center text-muted py-3">Error loading products</div>',
                    );
                });
            }

            function displaySearchResults(products) {
                const container = $("#searchResults");
                container.empty();

                if (products.length === 0) {
                    container.html(
                        '<div class="text-center text-muted py-3">No products found</div>',
                    );
                    return;
                }

                products.forEach((product) => {
                    const isInStock = product.current_stock > 0;
                    const stockClass = isInStock ? "in-stock" : "out-of-stock";
                    const stockText = isInStock
                        ? `${product.current_stock} in stock`
                        : "Out of stock";

                    const result = $(`
                    <div class="product-result" onclick='${isInStock ? `addToCart(${JSON.stringify(product).replace(/'/g, "\\'")})` : ""}'
                         style="${!isInStock ? "opacity: 0.6; cursor: not-allowed;" : ""}">
                        <img src="${product.image_url || '/static/img/placeholder.png'}" alt="${product.name}">
                        <div class="product-info">
                            <div class="product-name">${product.name}</div>
                            <div class="product-meta">
                                ${product.brand_name || ""} ${product.model_name || ""}
                                ${product.sku ? `â€¢ SKU: ${product.sku}` : ""}
                            </div>
                        </div>
                        <div class="product-price">â‚¹${parseFloat(product.selling_price).toFixed(2)}</div>
                        <span class="stock-badge ${stockClass}">${stockText}</span>
                    </div>
                `);
                    container.append(result);
                });
            }

            function addToCart(product) {
                if (product.current_stock <= 0) {
                    alert("This product is out of stock");
                    return;
                }

                const existingIndex = cart.findIndex(
                    (item) => item.product_id === product.id,
                );

                if (existingIndex >= 0) {
                    if (cart[existingIndex].quantity < product.current_stock) {
                        cart[existingIndex].quantity++;
                    } else {
                        alert("Cannot add more than available stock");
                        return;
                    }
                } else {
                    cart.push({
                        product_id: product.id,
                        product_name: product.name,
                        sku: product.sku || "N/A",
                        unit_price: parseFloat(product.selling_price),
                        quantity: 1,
                        max_stock: product.current_stock,
                        category_name: product.category_name || "",
                        imei_numbers: [],
                        imei_ids: [],
                        manual_imeis: [],
                        item_discount: 0, // Default to 0 for new items
                    });
                }

                updateCart();
                $("#productSearch").val("").focus();
                $("#searchResults").empty();
            }

            function updateCart() {
                const container = $("#cartItems");
                container.empty();

                if (cart.length === 0) {
                    container.html(`
                    <div class="empty-cart">
                        <i class="bi bi-cart-x"></i>
                        <h5>Cart is empty</h5>
                        <p>Search and add products to start billing</p>
                    </div>
                `);
                    $("#cartCount").text(0);
                    calculateTotals(); // Ensure totals are recalculated when cart is empty
                    return;
                }

                cart.forEach((item, index) => {
                    // Check if this is a smartphone category
                    const isSmartphone = item.category_name &&
                        item.category_name.toLowerCase().includes('smartphone');

                    const imeiComplete =
                        item.imei_numbers.length === item.quantity;
                    const imeiStatusClass = imeiComplete
                        ? "complete"
                        : "incomplete";
                    const imeiStatusText = imeiComplete
                        ? `${item.imei_numbers.length}/${item.quantity} Complete`
                        : `${item.imei_numbers.length}/${item.quantity} Incomplete`;

                    // Build IMEI section HTML only for smartphones
                    const imeiSectionHtml = isSmartphone ? `
                        <div class="imei-section">
                            <div class="imei-header">
                                <span class="imei-label">
                                    <i class="bi bi-upc-scan"></i> IMEI Numbers (${item.quantity} required)
                                </span>
                                <span class="imei-status ${imeiStatusClass}">${imeiStatusText}</span>
                            </div>
                            <div class="imei-input-group">
                                <button class="btn btn-sm btn-outline-primary" onclick="showIMEISelection(${index})" style="margin-right: 8px;">
                                    <i class="bi bi-list-check"></i> Select from Inventory
                                </button>
                                <input type="text" class="imei-input" id="imeiInput${index}"
                                       placeholder="Or enter IMEI manually"
                                       onkeypress="handleIMEIKeypress(event, ${index})" style="flex: 1;">
                                <button class="imei-add-btn" onclick="addIMEI(${index})">
                                    <i class="bi bi-plus-lg"></i> Add
                                </button>
                            </div>
                            <div class="imei-list" id="imeiList${index}"></div>
                        </div>
                    ` : '';

                    const itemSubtotal = item.quantity * item.unit_price;
                    const itemDiscount = parseFloat(item.item_discount) || 0;
                    const itemTotal = itemSubtotal - itemDiscount;

                    const cartItem = $(`
                    <div class="cart-item">
                        <div class="cart-item-header">
                            <div>
                                <div class="cart-item-name">${item.product_name}</div>
                                <div class="cart-item-sku">SKU: ${item.sku}</div>
                            </div>
                            <button class="btn btn-icon btn-danger" onclick="removeFromCart(${index})">
                                <i class="bi bi-trash"></i>
                            </button>
                        </div>

                        <div class="cart-item-controls">
                            <div class="qty-control">
                                <button class="qty-btn" onclick="updateQuantity(${index}, -1)">
                                    <i class="bi bi-dash"></i>
                                </button>
                                <span class="qty-value">${item.quantity}</span>
                                <button class="qty-btn" onclick="updateQuantity(${index}, 1)">
                                    <i class="bi bi-plus"></i>
                                </button>
                            </div>
                            <div class="cart-item-price">
                                <div class="cart-item-unit-price">â‚¹${item.unit_price.toFixed(2)} each</div>
                                <div class="cart-item-total">â‚¹${itemTotal.toFixed(2)}</div>
                            </div>
                        </div>

                        <div class="cart-item-discount">
                            <label><i class="bi bi-tag"></i> Item Discount:</label>
                            <input type="number" class="form-input" value="${itemDiscount.toFixed(2)}"
                                   min="0" max="100" step="0.1"
                                   onchange="updateItemDiscount(${index}, this.value)"
                                   placeholder="0.00">
                            <span style="font-size: 12px; color: var(--gray-500);">%</span>
                        </div>

                        ${imeiSectionHtml}
                    </div>
                `);

                    container.append(cartItem);

                    item.imei_numbers.forEach((imei, imeiIndex) => {
                        $(`#imeiList${index}`).append(`
                        <span class="imei-tag">
                            ${imei}
                            <button onclick="removeIMEI(${index}, ${imeiIndex})">
                                <i class="bi bi-x-lg"></i>
                            </button>
                        </span>
                    `);
                    });
                });

                $("#cartCount").text(cart.length);
                calculateTotals();
            }

            function handleIMEIKeypress(event, cartIndex) {
                if (event.key === "Enter") {
                    event.preventDefault();
                    addIMEI(cartIndex);
                }
            }

            function addIMEI(cartIndex) {
                const item = cart[cartIndex];
                const input = $(`#imeiInput${cartIndex}`);
                const imei = input.val().trim();

                if (!imei) {
                    alert("Please enter an IMEI number");
                    return;
                }

                if (!/^\d{15}$/.test(imei)) {
                    alert("IMEI must be exactly 15 digits");
                    return;
                }

                if (item.imei_numbers.includes(imei)) {
                    alert("This IMEI has already been added");
                    return;
                }

                if (item.imei_numbers.length >= item.quantity) {
                    alert(`Maximum ${item.quantity} IMEI number(s) allowed`);
                    return;
                }

                $.get(
                    `${API_BASE}/products/${item.product_id}/imeis/verify?imei=${imei}`,
                    function (response) {
                        if (response.available) {
                            item.imei_numbers.push(imei);
                            item.imei_ids.push(response.imei_id);
                            input.val("");
                            updateCart();
                        } else if (response.exists && !response.available) {
                            alert("This IMEI is already sold or not available");
                        } else {
                            item.imei_numbers.push(imei);
                            if (!item.manual_imeis) item.manual_imeis = [];
                            item.manual_imeis.push(imei);
                            input.val("");
                            updateCart();
                        }
                    },
                ).fail(function () {
                    item.imei_numbers.push(imei);
                    if (!item.manual_imeis) item.manual_imeis = [];
                    item.manual_imeis.push(imei);
                    input.val("");
                    updateCart();
                });
            }

            function removeIMEI(cartIndex, imeiIndex) {
                cart[cartIndex].imei_numbers.splice(imeiIndex, 1);
                cart[cartIndex].imei_ids.splice(imeiIndex, 1);
                updateCart();
            }

            function showIMEISelection(cartIndex) {
                const item = cart[cartIndex];
                currentCartIndexForIMEI = cartIndex;

                $.get(`${API_BASE}/products/${item.product_id}/imeis?status=available`, function(imeis) {
                    $('#imeiProductName').text(item.product_name);
                    $('#imeiQuantityRequired').text(item.quantity);

                    const listBody = $('#imeiSelectionList');
                    listBody.empty();

                    if (imeis.length === 0) {
                        listBody.append(`
                            <tr>
                                <td colspan="3" class="text-center text-muted">
                                    <i class="bi bi-inbox"></i> No IMEI numbers available in inventory.<br>
                                    Please enter IMEI numbers manually.
                                </td>
                            </tr>
                        `);
                    } else {
                        imeis.forEach(imei => {
                            const isChecked = item.imei_ids && item.imei_ids.includes(imei.id) ? 'checked' : '';
                            listBody.append(`
                                <tr>
                                    <td>
                                        <div class="form-check">
                                            <input class="form-check-input imei-checkbox" type="checkbox"
                                                   value="${imei.id}" data-imei="${imei.imei}" ${isChecked}>
                                        </div>
                                    </td>
                                    <td><code>${imei.imei}</code></td>
                                    <td><span class="badge bg-success">Available</span></td>
                                </tr>
                            `);
                        });
                    }

                    $('#imeiSelectionError').hide();
                    const modal = new bootstrap.Modal($('#imeiSelectionModal'));
                    modal.show();
                }).fail(function() {
                    alert('Error loading IMEI inventory. Please try manual entry.');
                });
            }

            $('#confirmImeiSelectionBtn').click(function() {
                if (currentCartIndexForIMEI === null) return;

                const item = cart[currentCartIndexForIMEI];
                const selectedIMEIs = [];
                const selectedIds = [];

                $('.imei-checkbox:checked').each(function() {
                    selectedIds.push(parseInt($(this).val()));
                    selectedIMEIs.push($(this).data('imei'));
                });

                if (selectedIMEIs.length !== item.quantity) {
                    $('#imeiSelectionError').text(
                        `Please select exactly ${item.quantity} IMEI number(s). Currently selected: ${selectedIMEIs.length}`
                    ).show();
                    return;
                }

                item.imei_numbers = selectedIMEIs;
                item.imei_ids = selectedIds;
                item.manual_imeis = [];

                bootstrap.Modal.getInstance($('#imeiSelectionModal')).hide();
                $('#imeiSelectionError').hide();
                updateCart();
                currentCartIndexForIMEI = null;
            });

            function updateQuantity(index, change) {
                const item = cart[index];
                const newQty = item.quantity + change;

                if (newQty < 1) {
                    removeFromCart(index);
                    return;
                }

                if (newQty > item.max_stock) {
                    alert("Cannot exceed available stock");
                    return;
                }

                if (
                    newQty < item.quantity &&
                    item.imei_numbers.length > newQty
                ) {
                    item.imei_numbers = item.imei_numbers.slice(0, newQty);
                    item.imei_ids = item.imei_ids.slice(0, newQty);
                }

                item.quantity = newQty;
                updateCart();
            }

            function updateItemDiscount(index, discount) {
                const item = cart[index];
                const itemSubtotal = item.quantity * item.unit_price;
                const discountValue = parseFloat(discount) || 0;

                if (discountValue < 0) {
                    alert("Discount cannot be negative");
                    item.item_discount = 0;
                    updateCart();
                    return;
                }

                // Allow discounts up to 100%
                if (discountValue > 100) {
                    alert("Discount percentage cannot exceed 100%");
                    item.item_discount = 100; // Set to 100% if over
                    updateCart();
                    return;
                }

                item.item_discount = discountValue;
                updateCart();
            }

            function removeFromCart(index) {
                if (confirm("Remove this item from cart?")) {
                    cart.splice(index, 1);
                    updateCart();
                }
            }

            function clearCart() {
                if (cart.length === 0) return;
                if (confirm("Clear all items from cart?")) {
                    cart = [];
                    updateCart();
                }
            }

            function calculateTotals() {
                let subtotal = 0;
                let totalItemDiscounts = 0;
                const itemBreakdownContainer = document.getElementById('itemBreakdown');

                // Clear existing breakdown
                itemBreakdownContainer.innerHTML = '';

                // Calculate and display per-item breakdown
                if (cart.length > 0) {
                    let breakdownHTML = '<div style="font-size: 0.85rem; color: #666; margin-bottom: 0.5rem;">';

                    cart.forEach((item, index) => {
                        const itemSubtotal = item.quantity * item.unit_price;
                        const itemDiscountPercent = parseFloat(item.item_discount) || 0;
                        const itemDiscountAmount = itemSubtotal * (itemDiscountPercent / 100);
                        const itemTotal = itemSubtotal - itemDiscountAmount;

                        subtotal += itemSubtotal;
                        totalItemDiscounts += itemDiscountAmount;

                        breakdownHTML += `
                        <div style="display: flex; justify-content: space-between; padding: 0.25rem 0; border-bottom: 1px solid #f0f0f0;">
                            <div style="flex: 1;">
                                <div style="font-weight: 500; color: #333;">${item.product_name}</div>
                                <div style="font-size: 0.75rem; color: #999;">
                                    â‚¹${item.unit_price.toFixed(2)} Ã— ${item.quantity} = â‚¹${itemSubtotal.toFixed(2)}
                                    ${itemDiscountAmount > 0 ? `<br><span style="color: #ef4444;">Item Discount: -â‚¹${itemDiscountAmount.toFixed(2)} (${itemDiscountPercent}%)</span>` : ''}
                                </div>
                            </div>
                            <div style="font-weight: 500; color: #333;">â‚¹${itemTotal.toFixed(2)}</div>
                        </div>
                    `;
                    });

                    breakdownHTML += '</div>';
                    itemBreakdownContainer.innerHTML = breakdownHTML;
                }

                const discountPercent = parseFloat(document.getElementById('discountPercent').value) || 0;
                const taxPercent = parseFloat(document.getElementById('taxPercent').value) || 0;

                // Apply percentage discount on subtotal after item discounts
                const subtotalAfterItemDiscounts = subtotal - totalItemDiscounts;
                const additionalDiscountAmount = subtotalAfterItemDiscounts * (discountPercent / 100);
                const totalDiscountAmount = totalItemDiscounts + additionalDiscountAmount;

                const taxableAmount = subtotal - totalDiscountAmount;
                const taxAmount = taxableAmount * (taxPercent / 100);
                const total = taxableAmount + taxAmount;

                document.getElementById('subtotal').textContent = `â‚¹${subtotal.toFixed(2)}`;
                document.getElementById('discountAmount').textContent = `-â‚¹${totalDiscountAmount.toFixed(2)}`;
                document.getElementById('taxAmount').textContent = `+â‚¹${taxAmount.toFixed(2)}`;
                document.getElementById('total').textContent = `â‚¹${total.toFixed(2)}`;
            }

            function selectTransactionType(type, element) {
                currentTransactionType = type;
                $(".transaction-tab").removeClass("active");
                $(element).addClass("active");
            }

            function completeSale(printReceipt = false) {
                if (cart.length === 0) {
                    alert(
                        "Cart is empty. Please add products before completing the sale.",
                    );
                    return;
                }

                // Only validate IMEI for smartphones
                for (let item of cart) {
                    const isSmartphone = item.category_name &&
                        item.category_name.toLowerCase().includes('smartphone');

                    if (isSmartphone && item.imei_numbers.length < item.quantity) {
                        alert(
                            `Please add ${item.quantity} IMEI number(s) for "${item.product_name}". Currently only ${item.imei_numbers.length} added.`,
                        );
                        return;
                    }
                }

                const items = cart || [];
                const subtotal = items.reduce((sum, item) => sum + item.quantity * item.unit_price, 0);
                const discountPercent =
                    parseFloat($("#discountPercent").val()) || 0;
                const taxPercent = parseFloat($("#taxPercent").val()) || 0;

                // Calculate total item discounts (convert percentage to amount)
                const totalItemDiscounts = cart.reduce((sum, item) => {
                    const itemSubtotal = item.quantity * item.unit_price;
                    const itemDiscountPercent = parseFloat(item.item_discount) || 0;
                    const itemDiscountAmount = itemSubtotal * (itemDiscountPercent / 100);
                    return sum + itemDiscountAmount;
                }, 0);

                const saleData = {
                    transaction_type: currentTransactionType,
                    customer_name: $("#customerName").val().trim(),
                    customer_phone: $("#customerPhone").val().trim(),
                    customer_email: $("#customerEmail").val().trim(),
                    items: cart,
                    discount_percentage: discountPercent,
                    tax_percentage: taxPercent,
                    payment_method: $("#paymentMethod").val(),
                    total_item_discounts: totalItemDiscounts,
                };

                const totalText = $("#total").text();
                const transactionTypeText =
                    currentTransactionType.charAt(0).toUpperCase() +
                    currentTransactionType.slice(1);

                if (
                    !confirm(
                        `Complete ${transactionTypeText} for ${totalText}?`,
                    )
                ) {
                    return;
                }

                const $btn = $(".btn-success, .btn-primary");
                $btn.prop("disabled", true);
                $(".btn-success").html(
                    '<i class="bi bi-hourglass-split"></i> Processing...',
                );

                $.ajax({
                    url: `${API_BASE}/pos/sales`,
                    method: "POST",
                    contentType: "application/json",
                    data: JSON.stringify(saleData),
                    success: function (response) {
                        if (printReceipt) {
                            printSaleReceipt(response, saleData);
                        } else {
                            alert(
                                `âœ“ ${transactionTypeText} completed successfully!\n\nSale Number: ${response.sale_number}\nTotal Amount: â‚¹${Math.abs(response.total_amount).toFixed(2)}\n\nThank you for your business!`,
                            );
                        }

                        resetPOS();
                    },
                    error: function (xhr) {
                        const errorMsg =
                            xhr.responseJSON?.error ||
                            "Failed to complete sale. Please try again.";
                        alert("Error: " + errorMsg);
                        $btn.prop("disabled", false);
                        $(".btn-success").html(
                            '<i class="bi bi-check-circle-fill"></i> Complete Sale',
                        );
                    },
                });
            }

            function printSaleReceipt(saleResponse, saleData) {
                $.get(`${API_BASE}/business-settings`, function(businessSettings) {
                    generateGSTInvoice(saleResponse, saleData, businessSettings);
                }).fail(function() {
                    alert('Could not load business settings. Please configure Business Settings first.');
                });
            }

            function generateGSTInvoice(saleResponse, saleData, businessSettings) {
                const printWindow = window.open('', '', 'width=900,height=700');
                const date = new Date();

                const items = saleData.items || [];
                const subtotal = items.reduce((sum, item) => sum + item.quantity * item.unit_price, 0);
                const discountAmount = subtotal * (saleData.discount_percentage / 100);
                const taxableAmount = subtotal - discountAmount;
                const taxAmount = taxableAmount * (saleData.tax_percentage / 100);
                const total = Math.abs(saleResponse.total_amount);

                const customerState = saleData.customer_address || '';
                const businessState = businessSettings.state || '';
                const isIGST = customerState && businessState && !customerState.toLowerCase().includes(businessState.toLowerCase());
                const cgstRate = isIGST ? 0 : saleData.tax_percentage / 2;
                const sgstRate = isIGST ? 0 : saleData.tax_percentage / 2;
                const igstRate = isIGST ? saleData.tax_percentage : 0;

                const cgstAmount = taxableAmount * (cgstRate / 100);
                const sgstAmount = taxableAmount * (sgstRate / 100);
                const igstAmount = taxableAmount * (igstRate / 100);

                function numberToWords(num) {
                    const ones = ['', 'One', 'Two', 'Three', 'Four', 'Five', 'Six', 'Seven', 'Eight', 'Nine'];
                    const tens = ['', '', 'Twenty', 'Thirty', 'Forty', 'Fifty', 'Sixty', 'Seventy', 'Eighty', 'Ninety'];
                    const teens = ['Ten', 'Eleven', 'Twelve', 'Thirteen', 'Fourteen', 'Fifteen', 'Sixteen', 'Seventeen', 'Eighteen', 'Nineteen'];

                    if (num === 0) return 'Zero';

                    const crores = Math.floor(num / 10000000);
                    const lakhs = Math.floor((num % 10000000) / 100000);
                    const thousands = Math.floor((num % 100000) / 1000);
                    const hundreds = Math.floor((num % 1000) / 100);
                    const remainder = num % 100;

                    let words = '';

                    if (crores > 0) words += ones[crores] + ' Crore ';
                    if (lakhs > 0) words += (lakhs < 10 ? ones[lakhs] : tens[Math.floor(lakhs / 10)] + ' ' + ones[lakhs % 10]) + ' Lakh ';
                    if (thousands > 0) words += (thousands < 10 ? ones[thousands] : tens[Math.floor(thousands / 10)] + ' ' + ones[thousands % 10]) + ' Thousand ';
                    if (hundreds > 0) words += ones[hundreds] + ' Hundred ';

                    if (remainder >= 20) {
                        words += tens[Math.floor(remainder / 10)] + ' ' + ones[remainder % 10];
                    } else if (remainder >= 10) {
                        words += teens[remainder - 10];
                    } else if (remainder > 0) {
                        words += ones[remainder];
                    }

                    return words.trim();
                }

                const totalInWords = numberToWords(Math.floor(total)) + ' Rupees Only';

                let itemsHtml = '';
                let srNo = 1;
                let totalQuantity = 0;
                let totalTaxableValue = 0;
                let totalCgstAmount = 0;
                let totalSgstAmount = 0;
                let totalIgstAmount = 0;
                let totalAmount = 0;

                items.forEach(item => {
                    const itemSubtotal = item.quantity * item.unit_price;
                    const itemDiscountPercent = parseFloat(item.item_discount) || 0;
                    const itemDiscountAmount = itemSubtotal * (itemDiscountPercent / 100);
                    const itemTaxableValue = itemSubtotal - itemDiscountAmount;

                    let itemCgstAmount = 0;
                    let itemSgstAmount = 0;
                    let itemIgstAmount = 0;

                    if (isIGST) {
                        itemIgstAmount = itemTaxableValue * (igstRate / 100);
                    } else {
                        itemCgstAmount = itemTaxableValue * (cgstRate / 100);
                        itemSgstAmount = itemTaxableValue * (sgstRate / 100);
                    }

                    const itemTotalTax = itemIgstAmount + itemCgstAmount + itemSgstAmount;
                    const itemTotal = itemTaxableValue + itemTotalTax;

                    totalQuantity += item.quantity;
                    totalTaxableValue += itemTaxableValue;
                    totalCgstAmount += itemCgstAmount;
                    totalSgstAmount += itemSgstAmount;
                    totalIgstAmount += itemIgstAmount;
                    totalAmount += itemTotal;

                    let imeiDisplay = '';
                    if (item.imei_numbers && item.imei_numbers.length > 0) {
                        imeiDisplay = '<br><span style="font-size: 9px; color: #333; font-family: monospace;">IMEI: ' + item.imei_numbers.join('<br>IMEI: ') + '</span>';
                    }

                    let discountDisplay = '';
                    if (itemDiscountAmount > 0) {
                        discountDisplay = '<br><span style="font-size: 9px; color: #ef4444;">Discount: -â‚¹' + itemDiscountAmount.toFixed(2) + ' (' + itemDiscountPercent.toFixed(1) + '%)</span>';
                    }

                    itemsHtml += `
                        <tr>
                            <td style="text-align: center; padding: 6px 4px; border: 1px solid #000;">${srNo++}</td>
                            <td style="padding: 6px 8px; border: 1px solid #000;">
                                <strong>${item.product_name}</strong>${imeiDisplay}${discountDisplay}
                            </td>
                            <td style="text-align: center; padding: 6px 4px; border: 1px solid #000;">8517</td>
                            <td style="text-align: center; padding: 6px 4px; border: 1px solid #000;">${item.quantity} NOS</td>
                            <td style="text-align: right; padding: 6px 8px; border: 1px solid #000;">â‚¹${item.unit_price.toFixed(2)}</td>
                            <td style="text-align: right; padding: 6px 8px; border: 1px solid #000;">â‚¹${itemTaxableValue.toFixed(2)}</td>
                            ${isIGST ? `
                                <td style="text-align: center; padding: 6px 4px; border: 1px solid #000;">${igstRate.toFixed(2)}</td>
                                <td style="text-align: right; padding: 6px 8px; border: 1px solid #000;">â‚¹${itemIgstAmount.toFixed(2)}</td>
                            ` : `
                                <td style="text-align: center; padding: 6px 4px; border: 1px solid #000;">${cgstRate.toFixed(2)}</td>
                                <td style="text-align: right; padding: 6px 8px; border: 1px solid #000;">â‚¹${itemCgstAmount.toFixed(2)}</td>
                                <td style="text-align: center; padding: 6px 4px; border: 1px solid #000;">${sgstRate.toFixed(2)}</td>
                                <td style="text-align: right; padding: 6px 8px; border: 1px solid #000;">â‚¹${itemSgstAmount.toFixed(2)}</td>
                            `}
                            <td style="text-align: right; padding: 6px 8px; font-weight: bold; border: 1px solid #000;">â‚¹${itemTotal.toFixed(2)}</td>
                        </tr>
                    `;
                });

                itemsHtml += `
                    <tr style="font-weight: bold; background: #f0f0f0;">
                        <td colspan="3" style="text-align: right; padding: 8px; border: 1px solid #000;">Total</td>
                        <td style="text-align: center; padding: 8px; border: 1px solid #000;">${totalQuantity}</td>
                        <td style="border: 1px solid #000;"></td>
                        <td style="text-align: right; padding: 8px; border: 1px solid #000;">â‚¹${totalTaxableValue.toFixed(2)}</td>
                        ${isIGST ? `
                            <td style="border: 1px solid #000;"></td>
                            <td style="text-align: right; padding: 8px; border: 1px solid #000;">â‚¹${totalIgstAmount.toFixed(2)}</td>
                        ` : `
                            <td style="border: 1px solid #000;"></td>
                            <td style="text-align: right; padding: 8px; border: 1px solid #000;">â‚¹${totalCgstAmount.toFixed(2)}</td>
                            <td style="border: 1px solid #000;"></td>
                            <td style="text-align: right; padding: 8px; border: 1px solid #000;">â‚¹${totalSgstAmount.toFixed(2)}</td>
                        `}
                        <td style="text-align: right; padding: 8px; border: 1px solid #000;">â‚¹${totalAmount.toFixed(2)}</td>
                    </tr>
                `;

                printWindow.document.write(`
                    <!DOCTYPE html>
                    <html>
                    <head>
                        <title>Tax Invoice - ${saleResponse.sale_number}</title>
                        <style>
                            @media print {
                                body { margin: 0; }
                                .no-print { display: none; }
                                @page { margin: 8mm; size: A4; }
                            }
                            * { margin: 0; padding: 0; box-sizing: border-box; }
                            body {
                                font-family: Arial, sans-serif;
                                font-size: 11px;
                                line-height: 1.3;
                                color: #000;
                                max-width: 210mm;
                                margin: 0 auto;
                                padding: 8px;
                                background: #fff;
                            }
                            .header-section {
                                border: 2px solid #000;
                                margin-bottom: 2px;
                            }
                            .company-info {
                                padding: 8px 12px;
                                text-align: center;
                                border-bottom: 1px solid #000;
                            }
                            .company-name {
                                font-size: 22px;
                                font-weight: bold;
                                color: #1e40af;
                                margin-bottom: 4px;
                            }
                            .company-address {
                                font-size: 10px;
                                margin-bottom: 2px;
                            }
                            .tagline {
                                font-size: 9px;
                                font-style: italic;
                                padding: 4px;
                                background: #f0f0f0;
                                border-top: 1px solid #ddd;
                            }
                            .invoice-meta {
                                display: flex;
                                border: 2px solid #000;
                                border-top: none;
                                margin-bottom: 2px;
                            }
                            .gstin-box {
                                flex: 1;
                                border-right: 1px solid #000;
                                padding: 6px 8px;
                                background: #f9fafb;
                            }
                            .invoice-title-box {
                                flex: 1;
                                padding: 6px 8px;
                                text-align: center;
                                border-right: 1px solid #000;
                            }
                            .invoice-title {
                                font-size: 16px;
                                font-weight: bold;
                                color: #1e40af;
                            }
                            .original-label {
                                font-size: 9px;
                                font-weight: bold;
                            }
                            .customer-invoice-section {
                                display: flex;
                                border: 2px solid #000;
                                border-top: none;
                                margin-bottom: 2px;
                            }
                            .info-box {
                                flex: 1;
                                padding: 6px 8px;
                            }
                            .info-box.bordered {
                                border-right: 1px solid #000;
                            }
                            .info-header {
                                font-weight: bold;
                                font-size: 10px;
                                margin-bottom: 4px;
                                padding-bottom: 2px;
                                border-bottom: 1px solid #ddd;
                            }
                            .info-row {
                                display: flex;
                                margin-bottom: 2px;
                                font-size: 10px;
                            }
                            .info-label {
                                font-weight: bold;
                                min-width: 80px;
                            }
                            table {
                                width: 100%;
                                border-collapse: collapse;
                                border: 2px solid #000;
                                margin-bottom: 2px;
                            }
                            th {
                                background: #e5e7eb;
                                border: 1px solid #000;
                                padding: 6px 4px;
                                font-size: 10px;
                                font-weight: bold;
                                text-align: center;
                            }
                            td {
                                border: 1px solid #000;
                                font-size: 10px;
                            }
                            .summary-section {
                                display: flex;
                                border: 2px solid #000;
                                border-top: none;
                                margin-bottom: 2px;
                            }
                            .left-section {
                                flex: 1.2;
                                border-right: 1px solid #000;
                            }
                            .right-section {
                                flex: 1;
                            }
                            .amount-words {
                                padding: 8px;
                                border-bottom: 1px solid #000;
                                font-size: 10px;
                            }
                            .amount-words strong {
                                display: block;
                                margin-bottom: 2px;
                            }
                            .bank-section {
                                padding: 8px;
                            }
                            .bank-header {
                                font-weight: bold;
                                font-size: 10px;
                                margin-bottom: 4px;
                            }
                            .bank-details {
                                font-size: 10px;
                            }
                            .totals-box {
                                padding: 8px;
                            }
                            .total-row {
                                display: flex;
                                justify-content: space-between;
                                padding: 3px 0;
                                font-size: 10px;
                            }
                            .total-row.highlight {
                                background: #f0f0f0;
                                padding: 4px 6px;
                                margin: 2px -6px;
                                font-weight: bold;
                            }
                            .total-row.grand {
                                border-top: 2px solid #000;
                                padding-top: 6px;
                                margin-top: 4px;
                                font-size: 11px;
                                font-weight: bold;
                            }
                            .certified-text {
                                padding: 6px 8px;
                                text-align: right;
                                font-size: 9px;
                                border-bottom: 1px solid #000;
                            }
                            .terms-section {
                                border: 2px solid #000;
                                border-top: none;
                                padding: 8px;
                                margin-bottom: 2px;
                            }
                            .terms-title {
                                font-weight: bold;
                                font-size: 10px;
                                margin-bottom: 4px;
                            }
                            .terms-content {
                                font-size: 9px;
                                line-height: 1.4;
                            }
                            .signature-section {
                                text-align: right;
                                padding: 8px;
                                border: 2px solid #000;
                                border-top: none;
                            }
                            .signature-line {
                                margin-top: 40px;
                                padding-top: 4px;
                                border-top: 1px solid #000;
                                display: inline-block;
                                min-width: 180px;
                                text-align: center;
                                font-weight: bold;
                                font-size: 10px;
                            }
                            .print-btn {
                                margin: 20px auto;
                                display: block;
                                padding: 12px 40px;
                                background: #10b981;
                                color: white;
                                border: none;
                                cursor: pointer;
                                font-size: 14px;
                                border-radius: 6px;
                                font-weight: bold;
                                box-shadow: 0 2px 4px rgba(0,0,0,0.1);
                            }
                            .print-btn:hover {
                                background: #059669;
                            }
                        </style>
                    </head>
                    <body>
                        <div class="header-section">
                            <div class="company-info">
                                <div class="company-name">${businessSettings.business_name || 'Shree Mobile Shop'}</div>
                                <div class="company-address">
                                    G-156, Bakers Junction, Vasant Vihar, Tardeo Road, ${businessSettings.city || 'Mumbai'} - ${businessSettings.pincode || '400007'}<br>
                                    Ph: ${businessSettings.phone || '022 2222 3939'}
                                </div>
                            </div>
                            <div class="tagline">
                                Get All Your Desired Smart Phones From Apple To Vivo On Huge Discounts And Easy EMI
                            </div>
                        </div>

                        <div class="invoice-meta">
                            <div class="gstin-box">
                                <strong>GSTIN : </strong>${businessSettings.gstin || '26CORPP3939N1ZA'}
                            </div>
                            <div class="invoice-title-box">
                                <div class="invoice-title">TAX INVOICE</div>
                            </div>
                            <div class="gstin-box" style="border-right: none; text-align: right;">
                                <span class="original-label">ORIGINAL FOR RECIPIENT</span>
                            </div>
                        </div>

                        <div class="customer-invoice-section">
                            <div class="info-box bordered">
                                <div class="info-header">Customer Detail</div>
                                <div class="info-row">
                                    <span class="info-label">Name</span>
                                    <span>${saleData.customer_name && saleData.customer_name.trim() !== '' ? saleData.customer_name : 'Walk-in Customer'}</span>
                                </div>
                                <div class="info-row">
                                    <span class="info-label">Address</span>
                                    <span>${businessSettings.state || 'Gujarat'}</span>
                                </div>
                                <div class="info-row">
                                    <span class="info-label">PHONE</span>
                                    <span>${saleData.customer_phone || '-'}</span>
                                </div>
                                <div class="info-row">
                                    <span class="info-label">GSTIN</span>
                                    <span>-</span>
                                </div>
                                <div class="info-row">
                                    <span class="info-label">Place of Supply</span>
                                    <span>${businessSettings.state || 'Gujarat'} ( ${businessSettings.pincode ? businessSettings.pincode.substring(0, 2) : '24'} )</span>
                                </div>
                            </div>
                            <div class="info-box">
                                <div class="info-row" style="margin-bottom: 8px;">
                                    <span class="info-label">Invoice No.</span>
                                    <span style="font-weight: bold;">${saleResponse.sale_number.replace('POS-', '')}</span>
                                </div>
                                <div class="info-row">
                                    <span class="info-label">Invoice Date</span>
                                    <span>${date.toLocaleDateString('en-GB')}</span>
                                </div>
                            </div>
                        </div>

                        <table style="border-collapse: collapse; width: 100%; border: 2px solid #000;">
                            <thead>
                                <tr style="background: #e5e7eb;">
                                    <th style="width: 40px; padding: 8px 4px; border: 1px solid #000; font-size: 10px; text-align: center;">Sr.<br>No.</th>
                                    <th style="padding: 8px; border: 1px solid #000; font-size: 10px; text-align: center;">Name of Product / Service</th>
                                    <th style="width: 70px; padding: 8px 4px; border: 1px solid #000; font-size: 10px; text-align: center;">HSN / SAC</th>
                                    <th style="width: 60px; padding: 8px 4px; border: 1px solid #000; font-size: 10px; text-align: center;">Qty</th>
                                    <th style="width: 90px; padding: 8px; border: 1px solid #000; font-size: 10px; text-align: center;">Rate</th>
                                    <th style="width: 100px; padding: 8px; border: 1px solid #000; font-size: 10px; text-align: center;">Taxable Value</th>
                                    ${isIGST ? `
                                        <th colspan="2" style="width: 140px; padding: 8px; border: 1px solid #000; font-size: 10px; text-align: center; background: #dbeafe;">IGST</th>
                                    ` : `
                                        <th colspan="2" style="padding: 8px; border: 1px solid #000; font-size: 10px; text-align: center; background: #dbeafe;">CGST</th>
                                        <th colspan="2" style="padding: 8px; border: 1px solid #000; font-size: 10px; text-align: center; background: #fecaca;">SGST</th>
                                    `}
                                    <th style="width: 100px; padding: 8px; border: 1px solid #000; font-size: 10px; text-align: center;">Total</th>
                                </tr>
                                <tr style="background: #e5e7eb;">
                                    <th colspan="6" style="border: 1px solid #000;"></th>
                                    ${isIGST ? `
                                        <th style="width: 50px; padding: 4px; border: 1px solid #000; font-size: 9px; text-align: center; background: #dbeafe;">%</th>
                                        <th style="width: 90px; padding: 4px; border: 1px solid #000; font-size: 9px; text-align: center; background: #dbeafe;">Amount</th>
                                    ` : `
                                        <th style="width: 40px; padding: 4px; border: 1px solid #000; font-size: 9px; text-align: center; background: #dbeafe;">%</th>
                                        <th style="width: 70px; padding: 4px; border: 1px solid #000; font-size: 9px; text-align: center; background: #dbeafe;">Amount</th>
                                        <th style="width: 40px; padding: 4px; border: 1px solid #000; font-size: 9px; text-align: center; background: #fecaca;">%</th>
                                        <th style="width: 70px; padding: 4px; border: 1px solid #000; font-size: 9px; text-align: center; background: #fecaca;">Amount</th>
                                    `}
                                    <th style="border: 1px solid #000;"></th>
                                </tr>
                            </thead>
                            <tbody>
                                ${itemsHtml}
                            </tbody>
                        </table>

                        <div class="summary-section">
                            <div class="left-section">
                                <div class="amount-words">
                                    <strong>Total in words</strong>
                                    <div style="text-transform: uppercase;">${totalInWords.toUpperCase()}</div>
                                </div>
                                <div class="bank-section">
                                    <div class="bank-header">Bank Details</div>
                                    <div class="bank-details">
                                        <div class="info-row">
                                            <span class="info-label">Name</span>
                                            <span>${businessSettings.bank_name || 'ICICI'}</span>
                                        </div>
                                        <div class="info-row">
                                            <span class="info-label">Branch</span>
                                            <span>${businessSettings.bank_branch || 'Surat'}</span>
                                        </div>
                                        <div class="info-row">
                                            <span class="info-label">Acc. Number</span>
                                            <span>${businessSettings.bank_account_number || '271550'}</span>
                                        </div>
                                        <div class="info-row">
                                            <span class="info-label">IFSC</span>
                                            <span>${businessSettings.bank_ifsc || 'ICIC045F'}</span>
                                        </div>
                                        <div class="info-row" style="margin-top: 8px;">
                                            <span class="info-label">UPI ID</span>
                                            <span>ifox@icici</span>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="right-section">
                                <div class="totals-box">
                                    <div class="total-row highlight">
                                        <span>Taxable Amount</span>
                                        <span>â‚¹${totalTaxableValue.toFixed(2)}</span>
                                    </div>
                                    ${isIGST ? `
                                    <div class="total-row">
                                        <span>Add: IGST ${igstRate.toFixed(2)}%</span>
                                        <span>â‚¹${totalIgstAmount.toFixed(2)}</span>
                                    </div>
                                    ` : `
                                    <div class="total-row">
                                        <span>Add: CGST ${cgstRate.toFixed(2)}%</span>
                                        <span>â‚¹${totalCgstAmount.toFixed(2)}</span>
                                    </div>
                                    <div class="total-row">
                                        <span>Add: SGST ${sgstRate.toFixed(2)}%</span>
                                        <span>â‚¹${totalSgstAmount.toFixed(2)}</span>
                                    </div>
                                    `}
                                    <div class="total-row">
                                        <span>Total Tax</span>
                                        <span>â‚¹${(totalIgstAmount + totalCgstAmount + totalSgstAmount).toFixed(2)}</span>
                                    </div>
                                    <div class="total-row grand" style="background: #f0f0f0; margin: 4px -8px; padding: 6px 8px;">
                                        <span>Total Amount After Tax</span>
                                        <span>â‚¹${totalAmount.toFixed(2)}</span>
                                    </div>
                                </div>
                                <div class="certified-text">
                                    (E & O.E)<br>
                                    Certified that the particulars given above are true and correct.<br>
                                    <strong>For ${businessSettings.business_name || 'Mobile Shop'}</strong>
                                </div>
                            </div>
                        </div>

                        <div class="terms-section">
                            <div class="terms-title">Terms and Conditions</div>
                            <div class="terms-content">
                                Subject to Maharashtra Junction.<br>
                                Our Responsibility Ceases as soon as goods leaves our Premises.<br>
                                Goods once sold will not taken back.<br>
                                Delivery Ex-Premises.
                            </div>
                            <div class="signature-section" style="border: none; padding-top: 20px;">
                                <div class="signature-line">Authorised Signatory</div>
                            </div>
                        </div>

                        <button class="print-btn no-print" onclick="window.print();">ðŸ–¨ï¸ Print Invoice</button>
                    </body>
                    </html>
                `);

                printWindow.document.close();

                setTimeout(() => {
                    printWindow.print();
                }, 500);
            }

            function resetPOS() {
                cart = [];
                updateCart();
                $("#customerName, #customerPhone, #customerEmail").val("");
                $("#discountPercent, #taxPercent").val(0);
                $("#paymentMethod").val("cash");
                $(".transaction-tab").removeClass("active");
                $('.transaction-tab[data-type="sale"]').addClass("active");
                currentTransactionType = "sale";
                $("#productSearch").val("").focus();
                $(".btn-success, .btn-primary").prop("disabled", false);
                $(".btn-success").html(
                    '<i class="bi bi-check-circle-fill"></i> Complete Sale'
                );
            }

            let customerLookupTimeout;
            let currentLookupRequest = null;

            $("#customerPhone").on("input", function() {
                const phone = $(this).val().trim();

                clearTimeout(customerLookupTimeout);

                if (currentLookupRequest) {
                    currentLookupRequest.abort();
                    currentLookupRequest = null;
                }

                if (phone.length >= 10) {
                    customerLookupTimeout = setTimeout(function() {
                        currentLookupRequest = $.ajax({
                            url: `/api/customers/lookup/${encodeURIComponent(phone)}`,
                            method: 'GET',
                            success: function(customer) {
                                const currentPhone = $("#customerPhone").val().trim();
                                if (customer.phone === currentPhone) {
                                    $("#customerName").val(customer.name);
                                    $("#customerEmail").val(customer.email || '');

                                    $("#customerPhone").css('border-color', '#10b981');
                                    setTimeout(() => {
                                        $("#customerPhone").css('border-color', '');
                                    }, 1000);
                                }
                                currentLookupRequest = null;
                            },
                            error: function(xhr) {
                                if (xhr.statusText !== 'abort') {
                                    const currentPhone = $("#customerPhone").val().trim();
                                    if (currentPhone === phone) {
                                        $("#customerName").val('');
                                        $("#customerEmail").val('');
                                    }
                                    $("#customerPhone").css('border-color', '');
                                }
                                currentLookupRequest = null;
                            }
                        });
                    }, 500);
                } else {
                    $("#customerName").val('');
                    $("#customerEmail").val('');
                    $("#customerPhone").css('border-color', '');
                }
            });

            $(document).ready(function () {
                loadCategories();
                calculateTotals();
            });

            $(document).on("keydown", function (e) {
                if (e.key === "F9") {
                    e.preventDefault();
                    $("#productSearch").focus();
                }

                if (e.key === "F12") {
                    e.preventDefault();
                    completeSale();
                }

                if (e.key === "Escape") {
                    if ($("#productSearch").val()) {
                        $("#productSearch").val("");
                        $("#searchResults").empty();
                    } else if (cart.length > 0) {
                        clearCart();
                    }
                }
            });

            // ========================================
            // HOLD BILL FUNCTIONALITY
            // ========================================
            function holdBill() {
                if (cart.length === 0) {
                    alert("Cart is empty. Nothing to hold.");
                    return;
                }

                const holdId = 'HOLD-' + Date.now();
                const holdData = {
                    id: holdId,
                    timestamp: new Date().toISOString(),
                    cart: JSON.parse(JSON.stringify(cart)),
                    customer: {
                        name: $('#customerName').val(),
                        phone: $('#customerPhone').val(),
                        email: $('#customerEmail').val()
                    },
                    billing: {
                        subtotal: $('#subtotal').text(),
                        discount: $('#discountPercent').val(),
                        tax: $('#taxPercent').val(),
                        total: $('#total').text()
                    },
                    paymentMethod: $('#paymentMethod').val(),
                    transactionType: currentTransactionType
                };

                // Get existing held bills
                let heldBills = JSON.parse(localStorage.getItem('heldBills') || '[]');
                heldBills.push(holdData);
                localStorage.setItem('heldBills', JSON.stringify(heldBills));

                alert(`Bill held successfully!\n\nHold ID: ${holdId}\nItems: ${cart.length}\nTotal: ${holdData.billing.total}`);
                
                // Clear cart after holding
                resetPOS();
            }

            // ========================================
            // RESUME BILL FUNCTIONALITY
            // ========================================
            function showResumeBillModal() {
                const heldBills = JSON.parse(localStorage.getItem('heldBills') || '[]');
                const container = $('#heldBillsList');
                container.empty();

                if (heldBills.length === 0) {
                    container.html(`
                        <div class="text-center text-muted py-5">
                            <i class="bi bi-inbox" style="font-size: 3rem;"></i>
                            <p class="mt-3">No held bills found</p>
                        </div>
                    `);
                } else {
                    heldBills.forEach((bill, index) => {
                        const date = new Date(bill.timestamp);
                        const dateStr = date.toLocaleDateString() + ' ' + date.toLocaleTimeString();
                        
                        container.append(`
                            <div class="card mb-3">
                                <div class="card-body">
                                    <div class="d-flex justify-content-between align-items-start">
                                        <div>
                                            <h6 class="mb-1"><i class="bi bi-receipt"></i> ${bill.id}</h6>
                                            <small class="text-muted">
                                                <i class="bi bi-clock"></i> ${dateStr}
                                            </small>
                                            <div class="mt-2">
                                                <strong>Customer:</strong> ${bill.customer.name || 'Walk-in'}<br>
                                                <strong>Items:</strong> ${bill.cart.length}<br>
                                                <strong>Total:</strong> ${bill.billing.total}
                                            </div>
                                        </div>
                                        <div>
                                            <button class="btn btn-success btn-sm" onclick="resumeBill(${index})">
                                                <i class="bi bi-play-circle"></i> Resume
                                            </button>
                                            <button class="btn btn-danger btn-sm" onclick="deleteHeldBill(${index})">
                                                <i class="bi bi-trash"></i>
                                            </button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        `);
                    });
                }

                const modal = new bootstrap.Modal($('#resumeBillModal'));
                modal.show();
            }

            function resumeBill(index) {
                const heldBills = JSON.parse(localStorage.getItem('heldBills') || '[]');
                const bill = heldBills[index];

                if (!bill) {
                    alert('Bill not found');
                    return;
                }

                // Restore cart
                cart = JSON.parse(JSON.stringify(bill.cart));

                // Restore customer info
                $('#customerName').val(bill.customer.name || '');
                $('#customerPhone').val(bill.customer.phone || '');
                $('#customerEmail').val(bill.customer.email || '');

                // Restore billing
                $('#discountPercent').val(bill.billing.discount || 0);
                $('#taxPercent').val(bill.billing.tax || 0);
                $('#paymentMethod').val(bill.paymentMethod || 'cash');

                // Restore transaction type
                currentTransactionType = bill.transactionType || 'sale';
                $('.transaction-tab').removeClass('active');
                $(`.transaction-tab[data-type="${currentTransactionType}"]`).addClass('active');

                // Remove from held bills
                heldBills.splice(index, 1);
                localStorage.setItem('heldBills', JSON.stringify(heldBills));

                // Update UI
                updateCart();
                bootstrap.Modal.getInstance($('#resumeBillModal')).hide();

                alert(`Bill ${bill.id} resumed successfully!`);
            }

            function deleteHeldBill(index) {
                if (!confirm('Are you sure you want to delete this held bill?')) {
                    return;
                }

                const heldBills = JSON.parse(localStorage.getItem('heldBills') || '[]');
                heldBills.splice(index, 1);
                localStorage.setItem('heldBills', JSON.stringify(heldBills));

                showResumeBillModal();
            }

            // ========================================
            // SAVE BILL FUNCTIONALITY
            // ========================================
            function saveBillDraft() {
                if (cart.length === 0) {
                    alert("Cart is empty. Nothing to save.");
                    return;
                }

                const billId = 'DRAFT-' + Date.now();
                const billData = {
                    id: billId,
                    timestamp: new Date().toISOString(),
                    date: new Date().toLocaleDateString(),
                    time: new Date().toLocaleTimeString(),
                    cart: JSON.parse(JSON.stringify(cart)),
                    customer: {
                        name: $('#customerName').val() || 'Walk-in Customer',
                        phone: $('#customerPhone').val() || '',
                        email: $('#customerEmail').val() || ''
                    },
                    billing: {
                        subtotal: parseFloat($('#subtotal').text().replace('â‚¹', '')),
                        discountPercent: parseFloat($('#discountPercent').val()) || 0,
                        discountAmount: parseFloat($('#discountAmount').text().replace('-â‚¹', '')),
                        taxPercent: parseFloat($('#taxPercent').val()) || 0,
                        taxAmount: parseFloat($('#taxAmount').text().replace('+â‚¹', '')),
                        total: parseFloat($('#total').text().replace('â‚¹', ''))
                    },
                    paymentMethod: $('#paymentMethod').val(),
                    transactionType: currentTransactionType,
                    status: 'draft'
                };

                // Save to localStorage
                let savedBills = JSON.parse(localStorage.getItem('savedBills') || '[]');
                savedBills.push(billData);
                localStorage.setItem('savedBills', JSON.stringify(savedBills));

                alert(`Bill saved successfully!\n\nBill ID: ${billId}\nTotal: â‚¹${billData.billing.total.toFixed(2)}\n\nYou can access saved bills from localStorage.`);
            }

            // ========================================
            // PRINT BILL FUNCTIONALITY
            // ========================================
            function printBillOnly() {
                if (cart.length === 0) {
                    alert("Cart is empty. Nothing to print.");
                    return;
                }

                const billId = 'PRINT-' + Date.now();
                const date = new Date();
                
                const subtotal = parseFloat($('#subtotal').text().replace('â‚¹', ''));
                const discountPercent = parseFloat($('#discountPercent').val()) || 0;
                const discountAmount = parseFloat($('#discountAmount').text().replace('-â‚¹', ''));
                const taxPercent = parseFloat($('#taxPercent').val()) || 0;
                const taxAmount = parseFloat($('#taxAmount').text().replace('+â‚¹', ''));
                const total = parseFloat($('#total').text().replace('â‚¹', ''));

                let itemsHtml = '';
                cart.forEach((item, index) => {
                    const itemSubtotal = item.quantity * item.unit_price;
                    const itemDiscountPercent = parseFloat(item.item_discount) || 0;
                    const itemDiscountAmount = itemSubtotal * (itemDiscountPercent / 100);
                    const itemTotal = itemSubtotal - itemDiscountAmount;

                    itemsHtml += `
                        <tr>
                            <td>${index + 1}</td>
                            <td>${item.product_name}</td>
                            <td style="text-align: center;">${item.quantity}</td>
                            <td style="text-align: right;">â‚¹${item.unit_price.toFixed(2)}</td>
                            <td style="text-align: right;">â‚¹${itemTotal.toFixed(2)}</td>
                        </tr>
                    `;
                });

                const printWindow = window.open('', '', 'width=800,height=600');
                printWindow.document.write(`
                    <!DOCTYPE html>
                    <html>
                    <head>
                        <title>Invoice - ${billId}</title>
                        <style>
                            * { margin: 0; padding: 0; box-sizing: border-box; }
                            body {
                                font-family: Arial, sans-serif;
                                padding: 20px;
                                font-size: 12px;
                            }
                            .header {
                                text-align: center;
                                margin-bottom: 20px;
                                border-bottom: 2px solid #000;
                                padding-bottom: 10px;
                            }
                            .company-name {
                                font-size: 24px;
                                font-weight: bold;
                                color: #1e40af;
                            }
                            .invoice-info {
                                display: flex;
                                justify-content: space-between;
                                margin-bottom: 20px;
                            }
                            table {
                                width: 100%;
                                border-collapse: collapse;
                                margin-bottom: 20px;
                            }
                            th, td {
                                border: 1px solid #ddd;
                                padding: 8px;
                            }
                            th {
                                background-color: #f0f0f0;
                                font-weight: bold;
                            }
                            .totals {
                                margin-left: auto;
                                width: 300px;
                            }
                            .totals tr td {
                                padding: 5px 10px;
                            }
                            .grand-total {
                                font-size: 16px;
                                font-weight: bold;
                                background-color: #f0f0f0;
                            }
                            .footer {
                                margin-top: 30px;
                                text-align: center;
                                font-size: 11px;
                                color: #666;
                            }
                            @media print {
                                .no-print { display: none; }
                            }
                        </style>
                    </head>
                    <body>
                        <div class="header">
                            <div class="company-name">Mobile Shop</div>
                            <div>Complete Mobile Solutions</div>
                        </div>

                        <div class="invoice-info">
                            <div>
                                <strong>Invoice No:</strong> ${billId}<br>
                                <strong>Date:</strong> ${date.toLocaleDateString()}<br>
                                <strong>Time:</strong> ${date.toLocaleTimeString()}
                            </div>
                            <div style="text-align: right;">
                                <strong>Customer:</strong> ${$('#customerName').val() || 'Walk-in Customer'}<br>
                                <strong>Phone:</strong> ${$('#customerPhone').val() || 'N/A'}<br>
                                <strong>Payment:</strong> ${$('#paymentMethod').val().toUpperCase()}
                            </div>
                        </div>

                        <table>
                            <thead>
                                <tr>
                                    <th style="width: 40px;">Sr.</th>
                                    <th>Product</th>
                                    <th style="width: 80px; text-align: center;">Qty</th>
                                    <th style="width: 100px; text-align: right;">Rate</th>
                                    <th style="width: 100px; text-align: right;">Amount</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${itemsHtml}
                            </tbody>
                        </table>

                        <table class="totals">
                            <tr>
                                <td>Subtotal:</td>
                                <td style="text-align: right;">â‚¹${subtotal.toFixed(2)}</td>
                            </tr>
                            <tr>
                                <td>Discount (${discountPercent}%):</td>
                                <td style="text-align: right; color: #dc3545;">-â‚¹${discountAmount.toFixed(2)}</td>
                            </tr>
                            <tr>
                                <td>Tax (${taxPercent}%):</td>
                                <td style="text-align: right;">+â‚¹${taxAmount.toFixed(2)}</td>
                            </tr>
                            <tr class="grand-total">
                                <td>Total Amount:</td>
                                <td style="text-align: right;">â‚¹${total.toFixed(2)}</td>
                            </tr>
                        </table>

                        <div class="footer">
                            <p>Thank you for your business!</p>
                            <p>This is a computer generated invoice</p>
                        </div>

                        <div class="no-print" style="text-align: center; margin-top: 20px;">
                            <button onclick="window.print()" style="padding: 10px 30px; font-size: 14px; background: #10b981; color: white; border: none; border-radius: 5px; cursor: pointer;">
                                ðŸ–¨ï¸ Print Invoice
                            </button>
                        </div>
                    </body>
                    </html>
                `);

                printWindow.document.close();
                setTimeout(() => {
                    printWindow.print();
                }, 300);
            }

            // ========================================
            // SAVED BILLS FUNCTIONALITY
            // ========================================
            function showSavedBillsModal() {
                const savedBills = JSON.parse(localStorage.getItem('savedBills') || '[]');
                const container = $('#savedBillsList');
                container.empty();

                if (savedBills.length === 0) {
                    container.html(`
                        <div class="text-center text-muted py-5">
                            <i class="bi bi-inbox" style="font-size: 3rem; color: #cbd5e1;"></i>
                            <h5 class="mt-3">No Saved Bills</h5>
                            <p>Save bills for later access and printing</p>
                        </div>
                    `);
                } else {
                    // Sort bills by timestamp (newest first)
                    savedBills.sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));
                    
                    savedBills.forEach((bill, index) => {
                        const date = new Date(bill.timestamp);
                        const dateStr = date.toLocaleDateString('en-IN', { 
                            day: '2-digit', 
                            month: 'short', 
                            year: 'numeric' 
                        }) + ' at ' + date.toLocaleTimeString('en-IN', { 
                            hour: '2-digit', 
                            minute: '2-digit' 
                        });
                        
                        const statusBadge = bill.status === 'draft' 
                            ? '<span class="badge bg-warning text-dark ms-2">Draft</span>' 
                            : '';
                        
                        container.append(`
                            <div class="card mb-3 shadow-sm">
                                <div class="card-body">
                                    <div class="row">
                                        <div class="col-md-8">
                                            <h6 class="mb-1">
                                                <i class="bi bi-receipt text-primary"></i> 
                                                <strong>${bill.id}</strong>
                                                ${statusBadge}
                                            </h6>
                                            <small class="text-muted">
                                                <i class="bi bi-clock"></i> ${dateStr}
                                            </small>
                                            <hr class="my-2">
                                            <div class="row mt-2">
                                                <div class="col-6">
                                                    <small class="text-muted">Customer:</small><br>
                                                    <strong>${bill.customer.name || 'Walk-in Customer'}</strong>
                                                </div>
                                                <div class="col-3">
                                                    <small class="text-muted">Items:</small><br>
                                                    <strong>${bill.cart.length}</strong>
                                                </div>
                                                <div class="col-3">
                                                    <small class="text-muted">Total:</small><br>
                                                    <strong class="text-success">â‚¹${bill.billing.total.toFixed(2)}</strong>
                                                </div>
                                            </div>
                                            ${bill.customer.phone ? `
                                                <div class="mt-2">
                                                    <small class="text-muted">
                                                        <i class="bi bi-phone"></i> ${bill.customer.phone}
                                                    </small>
                                                </div>
                                            ` : ''}
                                        </div>
                                        <div class="col-md-4 d-flex align-items-center justify-content-end">
                                            <div class="btn-group-vertical w-100">
                                                <button class="btn btn-success btn-sm" onclick="loadSavedBill(${index})">
                                                    <i class="bi bi-arrow-down-circle"></i> Load to Cart
                                                </button>
                                                <button class="btn btn-primary btn-sm" onclick="printSavedBill(${index})">
                                                    <i class="bi bi-printer-fill"></i> Print Invoice
                                                </button>
                                                <button class="btn btn-danger btn-sm" onclick="deleteSavedBill(${index})">
                                                    <i class="bi bi-trash3-fill"></i> Delete
                                                </button>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        `);
                    });
                }

                // Show the modal
                const modal = new bootstrap.Modal(document.getElementById('savedBillsModal'));
                modal.show();
            }

            function loadSavedBill(index) {
                const savedBills = JSON.parse(localStorage.getItem('savedBills') || '[]');
                const bill = savedBills[index];

                if (!bill) {
                    alert('Bill not found');
                    return;
                }

                // Restore cart
                cart = JSON.parse(JSON.stringify(bill.cart));

                // Restore customer info
                $('#customerName').val(bill.customer.name || '');
                $('#customerPhone').val(bill.customer.phone || '');
                $('#customerEmail').val(bill.customer.email || '');

                // Restore billing
                $('#discountPercent').val(bill.billing.discountPercent || 0);
                $('#taxPercent').val(bill.billing.taxPercent || 0);
                $('#paymentMethod').val(bill.paymentMethod || 'cash');

                // Restore transaction type
                currentTransactionType = bill.transactionType || 'sale';
                $('.transaction-tab').removeClass('active');
                $(`.transaction-tab[data-type="${currentTransactionType}"]`).addClass('active');

                // Update UI
                updateCart();
                bootstrap.Modal.getInstance($('#savedBillsModal')).hide();

                alert(`Bill ${bill.id} loaded successfully!`);
            }

            function printSavedBill(index) {
                const savedBills = JSON.parse(localStorage.getItem('savedBills') || '[]');
                const bill = savedBills[index];

                if (!bill) {
                    alert('Bill not found');
                    return;
                }

                // Create a mock sale response for printing
                const mockSaleResponse = {
                    sale_number: bill.id,
                    total_amount: bill.billing.total
                };

                const mockSaleData = {
                    items: bill.cart,
                    customer_name: bill.customer.name || 'Walk-in Customer',
                    customer_phone: bill.customer.phone || '',
                    customer_email: bill.customer.email || '',
                    discount_percentage: bill.billing.discountPercent || 0,
                    tax_percentage: bill.billing.taxPercent || 0,
                    payment_method: bill.paymentMethod || 'cash',
                    transaction_type: bill.transactionType || 'sale'
                };

                // Load business settings and generate invoice
                $.get(`${API_BASE}/business-settings`, function(businessSettings) {
                    generateGSTInvoice(mockSaleResponse, mockSaleData, businessSettings);
                }).fail(function() {
                    alert('Could not load business settings. Please configure Business Settings first.');
                });
            }

            function deleteSavedBill(index) {
                if (!confirm('Are you sure you want to delete this saved bill?')) {
                    return;
                }

                const savedBills = JSON.parse(localStorage.getItem('savedBills') || '[]');
                savedBills.splice(index, 1);
                localStorage.setItem('savedBills', JSON.stringify(savedBills));

                showSavedBillsModal();
            }

            // ========================================
            // SHARE VIA WHATSAPP FUNCTIONALITY
            // ========================================
            function shareViaWhatsApp() {
                if (cart.length === 0) {
                    alert("Cart is empty. Nothing to share.");
                    return;
                }

                const customerPhone = $('#customerPhone').val().trim();
                if (!customerPhone) {
                    alert("Please enter customer phone number to share via WhatsApp");
                    $('#customerPhone').focus();
                    return;
                }

                // Remove any non-digit characters
                const cleanPhone = customerPhone.replace(/\D/g, '');
                
                const billId = 'INV-' + Date.now();
                const date = new Date();
                
                const subtotal = parseFloat($('#subtotal').text().replace('â‚¹', ''));
                const discountPercent = parseFloat($('#discountPercent').val()) || 0;
                const discountAmount = parseFloat($('#discountAmount').text().replace('-â‚¹', ''));
                const taxPercent = parseFloat($('#taxPercent').val()) || 0;
                const taxAmount = parseFloat($('#taxAmount').text().replace('+â‚¹', ''));
                const total = parseFloat($('#total').text().replace('â‚¹', ''));

                // Build items list
                let itemsList = '';
                cart.forEach((item, index) => {
                    const itemSubtotal = item.quantity * item.unit_price;
                    const itemDiscountPercent = parseFloat(item.item_discount) || 0;
                    const itemDiscountAmount = itemSubtotal * (itemDiscountPercent / 100);
                    const itemTotal = itemSubtotal - itemDiscountAmount;
                    
                    itemsList += `${index + 1}. ${item.product_name}\n`;
                    itemsList += `   Qty: ${item.quantity} Ã— â‚¹${item.unit_price.toFixed(2)} = â‚¹${itemTotal.toFixed(2)}\n`;
                });

                // Create WhatsApp message
                const message = `ðŸ§¾ *INVOICE*

ðŸ“‹ Invoice No: ${billId}
ðŸ“… Date: ${date.toLocaleDateString()}
ðŸ• Time: ${date.toLocaleTimeString()}

ðŸ‘¤ Customer: ${$('#customerName').val() || 'Walk-in Customer'}

ðŸ“¦ *ITEMS*
${itemsList}

ðŸ’° *BILLING SUMMARY*
Subtotal: â‚¹${subtotal.toFixed(2)}
Discount (${discountPercent}%): -â‚¹${discountAmount.toFixed(2)}
Tax (${taxPercent}%): +â‚¹${taxAmount.toFixed(2)}
â”â”â”â”â”â”â”â”â”â”â”â”â”â”
*TOTAL: â‚¹${total.toFixed(2)}*

ðŸ’³ Payment: ${$('#paymentMethod').val().toUpperCase()}

Thank you for your business! ðŸ™`;

                // Encode message for URL
                const encodedMessage = encodeURIComponent(message);
                
                // Create WhatsApp URL
                const whatsappUrl = `https://wa.me/${cleanPhone}?text=${encodedMessage}`;
                
                // Open WhatsApp
                window.open(whatsappUrl, '_blank');
                
                alert(`WhatsApp link opened!\n\nSending invoice to: ${customerPhone}`);
            }
        </script>
    </body>
</html>