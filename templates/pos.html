<!doctype html>
<html lang="en">
    <head>
        <meta charset="UTF-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <title>Professional POS - Mobile Shop Manager</title>

        <!-- Bootstrap CSS -->
        <link
            href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css"
            rel="stylesheet"
        />
        <link
            rel="stylesheet"
            href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css"
        />

        <style>
            :root {
                --primary-color: #2563eb;
                --primary-dark: #1e40af;
                --success-color: #10b981;
                --danger-color: #ef4444;
                --warning-color: #f59e0b;
                --gray-50: #f9fafb;
                --gray-100: #f3f4f6;
                --gray-200: #e5e7eb;
                --gray-300: #d1d5db;
                --gray-600: #4b5563;
                --gray-700: #374151;
                --gray-900: #111827;
            }

            * {
                margin: 0;
                padding: 0;
                box-sizing: border-box;
            }

            body {
                background: var(--gray-100);
                font-family:
                    -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto,
                    "Helvetica Neue", Arial, sans-serif;
                min-height: 100vh;
            }

            /* Header */
            .pos-header {
                background: white;
                border-bottom: 1px solid var(--gray-200);
                padding: 1rem 1.5rem;
                box-shadow: 0 1px 3px 0 rgba(0, 0, 0, 0.1);
            }

            .pos-header h1 {
                font-size: 1.5rem;
                font-weight: 700;
                color: var(--gray-900);
                margin: 0;
            }

            .pos-header .subtitle {
                font-size: 0.875rem;
                color: var(--gray-600);
                margin-top: 0.25rem;
            }

            /* Main Container */
            .pos-main {
                display: flex;
                height: calc(100vh - 73px);
            }

            /* Left Panel - Products & Cart */
            .products-panel {
                flex: 1;
                display: flex;
                flex-direction: column;
                background: white;
                overflow: hidden;
            }

            /* Transaction Type Tabs */
            .transaction-tabs {
                display: flex;
                gap: 0;
                padding: 1rem 1.5rem 0;
                background: white;
                border-bottom: 2px solid var(--gray-200);
            }

            .transaction-tab {
                flex: 1;
                padding: 0.75rem 1rem;
                border: none;
                background: transparent;
                color: var(--gray-600);
                font-weight: 600;
                cursor: pointer;
                border-bottom: 3px solid transparent;
                transition: all 0.2s;
                position: relative;
                top: 2px;
            }

            .transaction-tab:hover {
                color: var(--primary-color);
                background: var(--gray-50);
            }

            .transaction-tab.active {
                color: var(--primary-color);
                border-bottom-color: var(--primary-color);
                background: transparent;
            }

            .transaction-tab i {
                margin-right: 0.5rem;
                font-size: 1.125rem;
            }

            /* Search Section */
            .search-section {
                padding: 1.5rem;
                background: white;
                border-bottom: 1px solid var(--gray-200);
            }

            .search-box {
                position: relative;
            }

            .search-box input {
                width: 100%;
                padding: 0.875rem 1rem 0.875rem 3rem;
                font-size: 1rem;
                border: 2px solid var(--gray-300);
                border-radius: 0.5rem;
                transition: all 0.2s;
            }

            .search-box input:focus {
                outline: none;
                border-color: var(--primary-color);
                box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.1);
            }

            .search-box i {
                position: absolute;
                left: 1rem;
                top: 50%;
                transform: translateY(-50%);
                font-size: 1.25rem;
                color: var(--gray-600);
            }

            /* Search Results */
            .search-results {
                padding: 1rem 1.5rem;
                max-height: 250px;
                overflow-y: auto;
                background: var(--gray-50);
            }

            .product-result {
                background: white;
                border: 1px solid var(--gray-200);
                border-radius: 0.5rem;
                padding: 1rem;
                margin-bottom: 0.75rem;
                cursor: pointer;
                transition: all 0.2s;
            }

            .product-result:hover {
                border-color: var(--primary-color);
                box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
                transform: translateY(-2px);
            }

            .product-result:active {
                transform: translateY(0);
            }

            .product-name {
                font-weight: 600;
                color: var(--gray-900);
                margin-bottom: 0.25rem;
            }

            .product-meta {
                font-size: 0.875rem;
                color: var(--gray-600);
                margin-bottom: 0.5rem;
            }

            .product-footer {
                display: flex;
                justify-content: space-between;
                align-items: center;
            }

            .product-price {
                font-size: 1.25rem;
                font-weight: 700;
                color: var(--success-color);
            }

            .stock-badge {
                padding: 0.25rem 0.75rem;
                border-radius: 9999px;
                font-size: 0.75rem;
                font-weight: 600;
            }

            .stock-badge.in-stock {
                background: #d1fae5;
                color: #065f46;
            }

            .stock-badge.out-of-stock {
                background: #fee2e2;
                color: #991b1b;
            }

            /* Cart Section */
            .cart-section {
                flex: 1;
                overflow-y: auto;
                padding: 1.5rem;
                background: var(--gray-50);
            }

            .cart-header {
                display: flex;
                justify-content: space-between;
                align-items: center;
                margin-bottom: 1rem;
            }

            .cart-title {
                font-size: 1.125rem;
                font-weight: 700;
                color: var(--gray-900);
                display: flex;
                align-items: center;
                gap: 0.5rem;
            }

            .cart-count {
                background: var(--primary-color);
                color: white;
                padding: 0.125rem 0.5rem;
                border-radius: 9999px;
                font-size: 0.75rem;
                font-weight: 600;
            }

            .cart-item {
                background: white;
                border: 1px solid var(--gray-200);
                border-radius: 0.5rem;
                padding: 1rem;
                margin-bottom: 0.75rem;
                box-shadow: 0 1px 2px 0 rgba(0, 0, 0, 0.05);
            }

            .cart-item-header {
                display: flex;
                justify-content: space-between;
                margin-bottom: 0.75rem;
            }

            .cart-item-name {
                font-weight: 600;
                color: var(--gray-900);
            }

            .cart-item-sku {
                font-size: 0.75rem;
                color: var(--gray-600);
                margin-top: 0.125rem;
            }

            .cart-item-controls {
                display: flex;
                justify-content: space-between;
                align-items: center;
                margin-bottom: 0.75rem;
            }

            .qty-control {
                display: flex;
                align-items: center;
                gap: 0.75rem;
            }

            .qty-btn {
                width: 2rem;
                height: 2rem;
                border-radius: 0.375rem;
                border: 1px solid var(--gray-300);
                background: white;
                color: var(--gray-700);
                font-weight: 600;
                cursor: pointer;
                transition: all 0.2s;
                display: flex;
                align-items: center;
                justify-content: center;
            }

            .qty-btn:hover {
                background: var(--primary-color);
                color: white;
                border-color: var(--primary-color);
            }

            .qty-value {
                font-weight: 700;
                color: var(--gray-900);
                min-width: 2rem;
                text-align: center;
            }

            .cart-item-price {
                text-align: right;
            }

            .cart-item-unit-price {
                font-size: 0.75rem;
                color: var(--gray-600);
            }

            .cart-item-total {
                font-size: 1.125rem;
                font-weight: 700;
                color: var(--success-color);
            }

            /* IMEI Section */
            .imei-section {
                padding: 0.75rem;
                background: var(--gray-50);
                border-radius: 0.375rem;
                border: 1px solid var(--gray-200);
            }

            .imei-header {
                display: flex;
                justify-content: space-between;
                align-items: center;
                margin-bottom: 0.5rem;
            }

            .imei-label {
                font-size: 0.875rem;
                font-weight: 600;
                color: var(--gray-700);
            }

            .imei-status {
                padding: 0.125rem 0.5rem;
                border-radius: 0.25rem;
                font-size: 0.75rem;
                font-weight: 600;
            }

            .imei-status.complete {
                background: #d1fae5;
                color: #065f46;
            }

            .imei-status.incomplete {
                background: #fef3c7;
                color: #92400e;
            }

            .imei-input-group {
                display: flex;
                gap: 0.5rem;
            }

            .imei-input {
                flex: 1;
                padding: 0.5rem;
                border: 1px solid var(--gray-300);
                border-radius: 0.375rem;
                font-family: "Courier New", monospace;
                font-size: 0.875rem;
            }

            .imei-input:focus {
                outline: none;
                border-color: var(--primary-color);
                box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.1);
            }

            .imei-add-btn {
                padding: 0.5rem 1rem;
                background: var(--primary-color);
                color: white;
                border: none;
                border-radius: 0.375rem;
                font-weight: 600;
                cursor: pointer;
                transition: all 0.2s;
            }

            .imei-add-btn:hover {
                background: var(--primary-dark);
            }

            .imei-list {
                margin-top: 0.5rem;
            }

            .imei-tag {
                display: inline-flex;
                align-items: center;
                gap: 0.5rem;
                padding: 0.375rem 0.75rem;
                background: white;
                border: 1px solid var(--gray-200);
                border-radius: 0.375rem;
                font-family: "Courier New", monospace;
                font-size: 0.75rem;
                margin-right: 0.5rem;
                margin-bottom: 0.5rem;
            }

            .imei-tag button {
                background: none;
                border: none;
                color: var(--danger-color);
                cursor: pointer;
                padding: 0;
                display: flex;
                align-items: center;
            }

            .empty-cart {
                text-align: center;
                padding: 3rem 1rem;
                color: var(--gray-600);
            }

            .empty-cart i {
                font-size: 4rem;
                margin-bottom: 1rem;
                color: var(--gray-300);
            }

            /* Right Panel - Billing */
            .billing-panel {
                width: 420px;
                background: white;
                border-left: 1px solid var(--gray-200);
                display: flex;
                flex-direction: column;
                overflow-y: auto;
            }

            .billing-section {
                padding: 1.5rem;
                border-bottom: 1px solid var(--gray-200);
            }

            .section-title {
                font-size: 1rem;
                font-weight: 700;
                color: var(--gray-900);
                margin-bottom: 1rem;
                display: flex;
                align-items: center;
                gap: 0.5rem;
            }

            .form-group {
                margin-bottom: 0.75rem;
            }

            .form-label {
                font-size: 0.875rem;
                font-weight: 600;
                color: var(--gray-700);
                margin-bottom: 0.375rem;
                display: block;
            }

            .form-input {
                width: 100%;
                padding: 0.625rem 0.75rem;
                border: 1px solid var(--gray-300);
                border-radius: 0.375rem;
                font-size: 0.875rem;
                transition: all 0.2s;
            }

            .form-input:focus {
                outline: none;
                border-color: var(--primary-color);
                box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.1);
            }

            /* Summary */
            .summary-row {
                display: flex;
                justify-content: space-between;
                align-items: center;
                margin-bottom: 0.75rem;
                font-size: 0.875rem;
            }

            .summary-label {
                color: var(--gray-600);
                font-weight: 500;
            }

            .summary-value {
                font-weight: 700;
                color: var(--gray-900);
            }

            .summary-row.discount .summary-value {
                color: var(--danger-color);
            }

            .summary-row.tax .summary-value {
                color: var(--gray-700);
            }

            .summary-row.total {
                padding-top: 0.75rem;
                border-top: 2px solid var(--gray-200);
                margin-top: 0.5rem;
            }

            .summary-row.total .summary-label {
                font-size: 1.125rem;
                font-weight: 700;
                color: var(--gray-900);
            }

            .summary-row.total .summary-value {
                font-size: 1.75rem;
                color: var(--success-color);
            }

            .input-group {
                display: flex;
                align-items: center;
                gap: 0.5rem;
            }

            .input-group input {
                width: 80px;
            }

            /* Buttons */
            .btn {
                padding: 0.75rem 1.5rem;
                border-radius: 0.5rem;
                font-weight: 600;
                cursor: pointer;
                transition: all 0.2s;
                border: none;
                display: inline-flex;
                align-items: center;
                justify-content: center;
                gap: 0.5rem;
            }

            .btn-primary {
                background: var(--primary-color);
                color: white;
            }

            .btn-primary:hover {
                background: var(--primary-dark);
                transform: translateY(-1px);
                box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
            }

            .btn-success {
                background: var(--success-color);
                color: white;
                width: 100%;
                padding: 1rem;
                font-size: 1.125rem;
            }

            .btn-success:hover {
                background: #059669;
                transform: translateY(-1px);
                box-shadow: 0 10px 15px -3px rgba(16, 185, 129, 0.3);
            }

            .btn-danger {
                background: var(--danger-color);
                color: white;
                padding: 0.5rem 1rem;
                font-size: 0.875rem;
            }

            .btn-danger:hover {
                background: #dc2626;
            }

            .btn-outline {
                background: white;
                color: var(--gray-700);
                border: 1px solid var(--gray-300);
                padding: 0.5rem 1rem;
                font-size: 0.875rem;
            }

            .btn-outline:hover {
                background: var(--gray-50);
                border-color: var(--gray-400);
            }

            .btn-icon {
                width: 2rem;
                height: 2rem;
                padding: 0;
                border-radius: 0.375rem;
            }

            /* Select */
            .form-select {
                width: 100%;
                padding: 0.75rem;
                border: 1px solid var(--gray-300);
                border-radius: 0.5rem;
                font-size: 1rem;
                font-weight: 600;
                cursor: pointer;
                transition: all 0.2s;
            }

            .form-select:focus {
                outline: none;
                border-color: var(--primary-color);
                box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.1);
            }

            /* Scrollbar */
            ::-webkit-scrollbar {
                width: 8px;
            }

            ::-webkit-scrollbar-track {
                background: var(--gray-100);
            }

            ::-webkit-scrollbar-thumb {
                background: var(--gray-300);
                border-radius: 4px;
            }

            ::-webkit-scrollbar-thumb:hover {
                background: var(--gray-400);
            }

            /* Responsive */
            @media (max-width: 1024px) {
                .billing-panel {
                    width: 360px;
                }
            }

            @media (max-width: 768px) {
                .pos-main {
                    flex-direction: column;
                    height: auto;
                }

                .billing-panel {
                    width: 100%;
                }
            }
        </style>
    </head>
    <body>
        <!-- Header -->
        <div class="pos-header">
            <div class="d-flex justify-content-between align-items-center">
                <div>
                    <h1><i class="bi bi-shop"></i> Point of Sale</h1>
                    <div class="subtitle">Mobile Shop Management System</div>
                </div>
                <button
                    class="btn btn-outline"
                    onclick="window.location.href='/'"
                >
                    <i class="bi bi-arrow-left"></i> Dashboard
                </button>
            </div>
        </div>

        <!-- Main Content -->
        <div class="pos-main">
            <!-- Left Panel - Products & Cart -->
            <div class="products-panel">
                <!-- Transaction Type Tabs -->
                <div class="transaction-tabs">
                    <button
                        class="transaction-tab active"
                        data-type="sale"
                        onclick="selectTransactionType('sale', this)"
                    >
                        <i class="bi bi-cart-check-fill"></i> Sale
                    </button>
                    <button
                        class="transaction-tab"
                        data-type="return"
                        onclick="selectTransactionType('return', this)"
                    >
                        <i class="bi bi-arrow-counterclockwise"></i> Return
                    </button>
                    <button
                        class="transaction-tab"
                        data-type="exchange"
                        onclick="selectTransactionType('exchange', this)"
                    >
                        <i class="bi bi-arrow-left-right"></i> Exchange
                    </button>
                </div>

                <!-- Product Search -->
                <div class="search-section">
                    <div class="search-box">
                        <i class="bi bi-search"></i>
                        <input
                            type="text"
                            id="productSearch"
                            placeholder="Search by product name, SKU, or scan barcode..."
                            autofocus
                        />
                    </div>
                </div>

                <!-- Search Results -->
                <div class="search-results" id="searchResults"></div>

                <!-- Shopping Cart -->
                <div class="cart-section">
                    <div class="cart-header">
                        <div class="cart-title">
                            <i class="bi bi-cart3"></i> Cart
                            <span class="cart-count" id="cartCount">0</span>
                        </div>
                        <button class="btn btn-outline" onclick="clearCart()">
                            <i class="bi bi-trash"></i> Clear Cart
                        </button>
                    </div>
                    <div id="cartItems">
                        <div class="empty-cart">
                            <i class="bi bi-cart-x"></i>
                            <h5>Cart is empty</h5>
                            <p>Search and add products to start billing</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Right Panel - Billing -->
            <div class="billing-panel">
                <!-- Customer Information -->
                <div class="billing-section">
                    <div class="section-title">
                        <i class="bi bi-person-circle"></i> Customer Information
                    </div>
                    <div class="form-group">
                        <label class="form-label"
                            >Customer Name (Optional)</label
                        >
                        <input
                            type="text"
                            id="customerName"
                            class="form-input"
                            placeholder="Enter customer name"
                        />
                    </div>
                    <div class="form-group">
                        <label class="form-label"
                            >Phone Number (Optional)</label
                        >
                        <input
                            type="tel"
                            id="customerPhone"
                            class="form-input"
                            placeholder="Enter phone number"
                        />
                    </div>
                    <div class="form-group">
                        <label class="form-label"
                            >Email Address (Optional)</label
                        >
                        <input
                            type="email"
                            id="customerEmail"
                            class="form-input"
                            placeholder="Enter email address"
                        />
                    </div>
                </div>

                <!-- Bill Summary -->
                <div class="billing-section" style="flex: 1">
                    <div class="section-title">
                        <i class="bi bi-receipt"></i> Bill Summary
                    </div>

                    <div class="summary-row">
                        <span class="summary-label">Subtotal</span>
                        <span class="summary-value" id="subtotal">$0.00</span>
                    </div>

                    <div class="summary-row">
                        <div class="input-group">
                            <span class="summary-label">Discount</span>
                            <input
                                type="number"
                                id="discountPercent"
                                class="form-input"
                                value="0"
                                min="0"
                                max="100"
                                step="0.1"
                                onchange="calculateTotals()"
                            />
                            <span class="summary-label">%</span>
                        </div>
                        <span class="summary-value discount" id="discountAmount"
                            >-$0.00</span
                        >
                    </div>

                    <div class="summary-row">
                        <div class="input-group">
                            <span class="summary-label">Tax</span>
                            <input
                                type="number"
                                id="taxPercent"
                                class="form-input"
                                value="0"
                                min="0"
                                max="100"
                                step="0.1"
                                onchange="calculateTotals()"
                            />
                            <span class="summary-label">%</span>
                        </div>
                        <span class="summary-value tax" id="taxAmount"
                            >+$0.00</span
                        >
                    </div>

                    <div class="summary-row total">
                        <span class="summary-label">Total Amount</span>
                        <span class="summary-value" id="total">$0.00</span>
                    </div>
                </div>

                <!-- Payment & Checkout -->
                <div class="billing-section">
                    <div class="form-group">
                        <label class="form-label">Payment Method</label>
                        <select class="form-select" id="paymentMethod">
                            <option value="cash">ðŸ’µ Cash</option>
                            <option value="card">ðŸ’³ Card</option>
                            <option value="upi">ðŸ“± UPI</option>
                            <option value="wallet">ðŸ‘› Wallet</option>
                        </select>
                    </div>

                    <div class="d-grid gap-2">
                        <button class="btn btn-success" onclick="completeSale(false)">
                            <i class="bi bi-check-circle-fill"></i> Complete Sale
                        </button>
                        <button class="btn btn-primary" onclick="completeSale(true)">
                            <i class="bi bi-printer-fill"></i> Save and Print
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- IMEI Selection Modal -->
        <div class="modal fade" id="imeiSelectionModal" tabindex="-1">
            <div class="modal-dialog modal-lg">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title"><i class="bi bi-upc-scan"></i> Select IMEI Numbers from Inventory</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                    </div>
                    <div class="modal-body">
                        <div class="alert alert-info">
                            <strong>Product:</strong> <span id="imeiProductName"></span><br>
                            <strong>Quantity Required:</strong> <span id="imeiQuantityRequired"></span>
                        </div>
                        <div class="table-responsive">
                            <table class="table table-hover">
                                <thead>
                                    <tr>
                                        <th width="50">Select</th>
                                        <th>IMEI Number</th>
                                        <th>Status</th>
                                    </tr>
                                </thead>
                                <tbody id="imeiSelectionList"></tbody>
                            </table>
                        </div>
                        <div id="imeiSelectionError" class="alert alert-danger" style="display:none;"></div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                        <button type="button" class="btn btn-primary" id="confirmImeiSelectionBtn">Confirm Selection</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Bootstrap JS -->
        <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
        <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

        <script>
            const API_BASE = "/api";
            let cart = [];
            let currentTransactionType = "sale";
            let searchTimeout = null;
            let currentCartIndexForIMEI = null;

            // Product Search
            $("#productSearch").on("input", function () {
                clearTimeout(searchTimeout);
                const query = $(this).val().trim();

                if (query.length < 2) {
                    $("#searchResults").empty();
                    return;
                }

                searchTimeout = setTimeout(() => {
                    searchProducts(query);
                }, 300);
            });

            function searchProducts(query) {
                $.get(
                    `${API_BASE}/pos/products/search?q=${encodeURIComponent(query)}`,
                    function (products) {
                        displaySearchResults(products);
                    },
                ).fail(function () {
                    $("#searchResults").html(
                        '<div class="text-center text-muted py-3">Error loading products</div>',
                    );
                });
            }

            function displaySearchResults(products) {
                const container = $("#searchResults");
                container.empty();

                if (products.length === 0) {
                    container.html(
                        '<div class="text-center text-muted py-3">No products found</div>',
                    );
                    return;
                }

                products.forEach((product) => {
                    const isInStock = product.current_stock > 0;
                    const stockClass = isInStock ? "in-stock" : "out-of-stock";
                    const stockText = isInStock
                        ? `${product.current_stock} in stock`
                        : "Out of stock";

                    const result = $(`
                    <div class="product-result" onclick='${isInStock ? `addToCart(${JSON.stringify(product).replace(/'/g, "\\'")})` : ""}'
                         style="${!isInStock ? "opacity: 0.6; cursor: not-allowed;" : ""}">
                        <div class="product-name">${product.name}</div>
                        <div class="product-meta">
                            ${product.brand_name || ""} ${product.model_name || ""}
                            ${product.sku ? `â€¢ SKU: ${product.sku}` : ""}
                        </div>
                        <div class="product-footer">
                            <div class="product-price">$${parseFloat(product.selling_price).toFixed(2)}</div>
                            <span class="stock-badge ${stockClass}">${stockText}</span>
                        </div>
                    </div>
                `);
                    container.append(result);
                });
            }

            function addToCart(product) {
                if (product.current_stock <= 0) {
                    alert("This product is out of stock");
                    return;
                }

                const existingIndex = cart.findIndex(
                    (item) => item.product_id === product.id,
                );

                if (existingIndex >= 0) {
                    if (cart[existingIndex].quantity < product.current_stock) {
                        cart[existingIndex].quantity++;
                        // Don't reset IMEIs on quantity increase
                    } else {
                        alert("Cannot add more than available stock");
                        return;
                    }
                } else {
                    cart.push({
                        product_id: product.id,
                        product_name: product.name,
                        sku: product.sku || "N/A",
                        unit_price: parseFloat(product.selling_price),
                        quantity: 1,
                        max_stock: product.current_stock,
                        imei_numbers: [],
                        imei_ids: [],
                        manual_imeis: [],
                    });
                }

                updateCart();
                $("#productSearch").val("").focus();
                $("#searchResults").empty();
            }

            function updateCart() {
                const container = $("#cartItems");
                container.empty();

                if (cart.length === 0) {
                    container.html(`
                    <div class="empty-cart">
                        <i class="bi bi-cart-x"></i>
                        <h5>Cart is empty</h5>
                        <p>Search and add products to start billing</p>
                    </div>
                `);
                    $("#cartCount").text(0);
                    calculateTotals();
                    return;
                }

                cart.forEach((item, index) => {
                    const imeiComplete =
                        item.imei_numbers.length === item.quantity;
                    const imeiStatusClass = imeiComplete
                        ? "complete"
                        : "incomplete";
                    const imeiStatusText = imeiComplete
                        ? `${item.imei_numbers.length}/${item.quantity} Complete`
                        : `${item.imei_numbers.length}/${item.quantity} Incomplete`;

                    const cartItem = $(`
                    <div class="cart-item">
                        <div class="cart-item-header">
                            <div>
                                <div class="cart-item-name">${item.product_name}</div>
                                <div class="cart-item-sku">SKU: ${item.sku}</div>
                            </div>
                            <button class="btn btn-icon btn-danger" onclick="removeFromCart(${index})">
                                <i class="bi bi-trash"></i>
                            </button>
                        </div>

                        <div class="cart-item-controls">
                            <div class="qty-control">
                                <button class="qty-btn" onclick="updateQuantity(${index}, -1)">
                                    <i class="bi bi-dash"></i>
                                </button>
                                <span class="qty-value">${item.quantity}</span>
                                <button class="qty-btn" onclick="updateQuantity(${index}, 1)">
                                    <i class="bi bi-plus"></i>
                                </button>
                            </div>
                            <div class="cart-item-price">
                                <div class="cart-item-unit-price">$${item.unit_price.toFixed(2)} each</div>
                                <div class="cart-item-total">$${(item.quantity * item.unit_price).toFixed(2)}</div>
                            </div>
                        </div>

                        <div class="imei-section">
                            <div class="imei-header">
                                <span class="imei-label">
                                    <i class="bi bi-upc-scan"></i> IMEI Numbers (${item.quantity} required)
                                </span>
                                <span class="imei-status ${imeiStatusClass}">${imeiStatusText}</span>
                            </div>
                            <div class="imei-input-group">
                                <button class="btn btn-sm btn-outline-primary" onclick="showIMEISelection(${index})" style="margin-right: 8px;">
                                    <i class="bi bi-list-check"></i> Select from Inventory
                                </button>
                                <input type="text" class="imei-input" id="imeiInput${index}"
                                       placeholder="Or enter IMEI manually"
                                       onkeypress="handleIMEIKeypress(event, ${index})" style="flex: 1;">
                                <button class="imei-add-btn" onclick="addIMEI(${index})">
                                    <i class="bi bi-plus-lg"></i> Add
                                </button>
                            </div>
                            <div class="imei-list" id="imeiList${index}"></div>
                        </div>
                    </div>
                `);

                    container.append(cartItem);

                    // Display existing IMEIs
                    item.imei_numbers.forEach((imei, imeiIndex) => {
                        $(`#imeiList${index}`).append(`
                        <span class="imei-tag">
                            ${imei}
                            <button onclick="removeIMEI(${index}, ${imeiIndex})">
                                <i class="bi bi-x-lg"></i>
                            </button>
                        </span>
                    `);
                    });
                });

                $("#cartCount").text(cart.length);
                calculateTotals();
            }

            function handleIMEIKeypress(event, cartIndex) {
                if (event.key === "Enter") {
                    event.preventDefault();
                    addIMEI(cartIndex);
                }
            }

            function addIMEI(cartIndex) {
                const item = cart[cartIndex];
                const input = $(`#imeiInput${cartIndex}`);
                const imei = input.val().trim();

                if (!imei) {
                    alert("Please enter an IMEI number");
                    return;
                }

                // Validate IMEI format (15 digits)
                if (!/^\d{15}$/.test(imei)) {
                    alert("IMEI must be exactly 15 digits");
                    return;
                }

                // Check if already added
                if (item.imei_numbers.includes(imei)) {
                    alert("This IMEI has already been added");
                    return;
                }

                // Check if we've reached the quantity limit
                if (item.imei_numbers.length >= item.quantity) {
                    alert(`Maximum ${item.quantity} IMEI number(s) allowed`);
                    return;
                }

                // Verify IMEI availability via API
                $.get(
                    `${API_BASE}/products/${item.product_id}/imeis/verify?imei=${imei}`,
                    function (response) {
                        if (response.available) {
                            // IMEI exists in inventory and is available
                            item.imei_numbers.push(imei);
                            item.imei_ids.push(response.imei_id);
                            input.val("");
                            updateCart();
                        } else if (response.exists && !response.available) {
                            // IMEI exists but is already sold
                            alert("This IMEI is already sold or not available");
                        } else {
                            // IMEI doesn't exist in inventory - add as manual entry
                            item.imei_numbers.push(imei);
                            if (!item.manual_imeis) item.manual_imeis = [];
                            item.manual_imeis.push(imei);
                            input.val("");
                            updateCart();
                        }
                    },
                ).fail(function () {
                    // If API fails, add as manual entry (will be created on server)
                    item.imei_numbers.push(imei);
                    if (!item.manual_imeis) item.manual_imeis = [];
                    item.manual_imeis.push(imei);
                    input.val("");
                    updateCart();
                });
            }

            function removeIMEI(cartIndex, imeiIndex) {
                cart[cartIndex].imei_numbers.splice(imeiIndex, 1);
                cart[cartIndex].imei_ids.splice(imeiIndex, 1);
                updateCart();
            }

            // IMEI Selection from Inventory
            function showIMEISelection(cartIndex) {
                const item = cart[cartIndex];
                currentCartIndexForIMEI = cartIndex;

                // Fetch available IMEIs for this product
                $.get(`${API_BASE}/products/${item.product_id}/imeis?status=available`, function(imeis) {
                    $('#imeiProductName').text(item.product_name);
                    $('#imeiQuantityRequired').text(item.quantity);

                    const listBody = $('#imeiSelectionList');
                    listBody.empty();

                    if (imeis.length === 0) {
                        listBody.append(`
                            <tr>
                                <td colspan="3" class="text-center text-muted">
                                    <i class="bi bi-inbox"></i> No IMEI numbers available in inventory.<br>
                                    Please enter IMEI numbers manually.
                                </td>
                            </tr>
                        `);
                    } else {
                        // Show available IMEIs with checkboxes
                        imeis.forEach(imei => {
                            const isChecked = item.imei_ids && item.imei_ids.includes(imei.id) ? 'checked' : '';
                            listBody.append(`
                                <tr>
                                    <td>
                                        <div class="form-check">
                                            <input class="form-check-input imei-checkbox" type="checkbox"
                                                   value="${imei.id}" data-imei="${imei.imei}" ${isChecked}>
                                        </div>
                                    </td>
                                    <td><code>${imei.imei}</code></td>
                                    <td><span class="badge bg-success">Available</span></td>
                                </tr>
                            `);
                        });
                    }

                    $('#imeiSelectionError').hide();
                    const modal = new bootstrap.Modal($('#imeiSelectionModal'));
                    modal.show();
                }).fail(function() {
                    alert('Error loading IMEI inventory. Please try manual entry.');
                });
            }

            // Confirm IMEI Selection
            $('#confirmImeiSelectionBtn').click(function() {
                if (currentCartIndexForIMEI === null) return;

                const item = cart[currentCartIndexForIMEI];
                const selectedIMEIs = [];
                const selectedIds = [];

                $('.imei-checkbox:checked').each(function() {
                    selectedIds.push(parseInt($(this).val()));
                    selectedIMEIs.push($(this).data('imei'));
                });

                if (selectedIMEIs.length !== item.quantity) {
                    $('#imeiSelectionError').text(
                        `Please select exactly ${item.quantity} IMEI number(s). Currently selected: ${selectedIMEIs.length}`
                    ).show();
                    return;
                }

                // Clear any manual entries and use selected IMEIs
                item.imei_numbers = selectedIMEIs;
                item.imei_ids = selectedIds;
                item.manual_imeis = []; // Clear manual entries

                bootstrap.Modal.getInstance($('#imeiSelectionModal')).hide();
                $('#imeiSelectionError').hide();
                updateCart();
                currentCartIndexForIMEI = null;
            });

            function updateQuantity(index, change) {
                const item = cart[index];
                const newQty = item.quantity + change;

                if (newQty < 1) {
                    removeFromCart(index);
                    return;
                }

                if (newQty > item.max_stock) {
                    alert("Cannot exceed available stock");
                    return;
                }

                // Adjust IMEI list if quantity decreases
                if (
                    newQty < item.quantity &&
                    item.imei_numbers.length > newQty
                ) {
                    item.imei_numbers = item.imei_numbers.slice(0, newQty);
                    item.imei_ids = item.imei_ids.slice(0, newQty);
                }

                item.quantity = newQty;
                updateCart();
            }

            function removeFromCart(index) {
                if (confirm("Remove this item from cart?")) {
                    cart.splice(index, 1);
                    updateCart();
                }
            }

            function clearCart() {
                if (cart.length === 0) return;
                if (confirm("Clear all items from cart?")) {
                    cart = [];
                    updateCart();
                }
            }

            function calculateTotals() {
                const subtotal = cart.reduce(
                    (sum, item) => sum + item.quantity * item.unit_price,
                    0,
                );
                const discountPercent =
                    parseFloat($("#discountPercent").val()) || 0;
                const taxPercent = parseFloat($("#taxPercent").val()) || 0;

                const discountAmount = subtotal * (discountPercent / 100);
                const taxableAmount = subtotal - discountAmount;
                const taxAmount = taxableAmount * (taxPercent / 100);
                const total = taxableAmount + taxAmount;

                $("#subtotal").text("$" + subtotal.toFixed(2));
                $("#discountAmount").text("-$" + discountAmount.toFixed(2));
                $("#taxAmount").text("+$" + taxAmount.toFixed(2));
                $("#total").text("$" + total.toFixed(2));
            }

            function selectTransactionType(type, element) {
                currentTransactionType = type;
                $(".transaction-tab").removeClass("active");
                $(element).addClass("active");
            }

            function completeSale(printReceipt = false) {
                if (cart.length === 0) {
                    alert(
                        "Cart is empty. Please add products before completing the sale.",
                    );
                    return;
                }

                // Validate IMEI numbers
                for (let item of cart) {
                    if (item.imei_numbers.length < item.quantity) {
                        alert(
                            `Please add ${item.quantity} IMEI number(s) for "${item.product_name}". Currently only ${item.imei_numbers.length} added.`,
                        );
                        return;
                    }
                }

                const subtotal = cart.reduce(
                    (sum, item) => sum + item.quantity * item.unit_price,
                    0,
                );
                const discountPercent =
                    parseFloat($("#discountPercent").val()) || 0;
                const taxPercent = parseFloat($("#taxPercent").val()) || 0;

                const saleData = {
                    transaction_type: currentTransactionType,
                    customer_name: $("#customerName").val().trim(),
                    customer_phone: $("#customerPhone").val().trim(),
                    customer_email: $("#customerEmail").val().trim(),
                    items: cart,
                    discount_percentage: discountPercent,
                    tax_percentage: taxPercent,
                    payment_method: $("#paymentMethod").val(),
                };

                const totalText = $("#total").text();
                const transactionTypeText =
                    currentTransactionType.charAt(0).toUpperCase() +
                    currentTransactionType.slice(1);

                if (
                    !confirm(
                        `Complete ${transactionTypeText} for ${totalText}?`,
                    )
                ) {
                    return;
                }

                // Disable buttons to prevent double submission
                const $btn = $(".btn-success, .btn-primary");
                $btn.prop("disabled", true);
                $(".btn-success").html(
                    '<i class="bi bi-hourglass-split"></i> Processing...',
                );

                $.ajax({
                    url: `${API_BASE}/pos/sales`,
                    method: "POST",
                    contentType: "application/json",
                    data: JSON.stringify(saleData),
                    success: function (response) {
                        if (printReceipt) {
                            printSaleReceipt(response, saleData);
                        } else {
                            alert(
                                `âœ“ ${transactionTypeText} completed successfully!\n\nSale Number: ${response.sale_number}\nTotal Amount: $${Math.abs(response.total_amount).toFixed(2)}\n\nThank you for your business!`,
                            );
                        }

                        // Reset everything
                        resetPOS();
                    },
                    error: function (xhr) {
                        const errorMsg =
                            xhr.responseJSON?.error ||
                            "Failed to complete sale. Please try again.";
                        alert("Error: " + errorMsg);
                        $btn.prop("disabled", false);
                        $(".btn-success").html(
                            '<i class="bi bi-check-circle-fill"></i> Complete Sale',
                        );
                    },
                });
            }

            function printSaleReceipt(saleResponse, saleData) {
                // Fetch business settings first
                $.get(`${API_BASE}/business-settings`, function(businessSettings) {
                    generateGSTInvoice(saleResponse, saleData, businessSettings);
                }).fail(function() {
                    // Fallback to simple receipt if business settings not available
                    alert('Could not load business settings. Please configure Business Settings first.');
                });
            }

            function generateGSTInvoice(saleResponse, saleData, businessSettings) {
                const printWindow = window.open('', '', 'width=900,height=700');
                const date = new Date();

                const subtotal = cart.reduce((sum, item) => sum + item.quantity * item.unit_price, 0);
                const discountAmount = subtotal * (saleData.discount_percentage / 100);
                const taxableAmount = subtotal - discountAmount;
                const taxAmount = taxableAmount * (saleData.tax_percentage / 100);
                const total = Math.abs(saleResponse.total_amount);

                // Determine if IGST or CGST+SGST (simplified - you can enhance based on state matching)
                const isIGST = false; // Set to true if inter-state
                const cgstRate = isIGST ? 0 : saleData.tax_percentage / 2;
                const sgstRate = isIGST ? 0 : saleData.tax_percentage / 2;
                const igstRate = isIGST ? saleData.tax_percentage : 0;

                const cgstAmount = taxableAmount * (cgstRate / 100);
                const sgstAmount = taxableAmount * (sgstRate / 100);
                const igstAmount = taxableAmount * (igstRate / 100);

                // Number to words conversion
                function numberToWords(num) {
                    const ones = ['', 'One', 'Two', 'Three', 'Four', 'Five', 'Six', 'Seven', 'Eight', 'Nine'];
                    const tens = ['', '', 'Twenty', 'Thirty', 'Forty', 'Fifty', 'Sixty', 'Seventy', 'Eighty', 'Ninety'];
                    const teens = ['Ten', 'Eleven', 'Twelve', 'Thirteen', 'Fourteen', 'Fifteen', 'Sixteen', 'Seventeen', 'Eighteen', 'Nineteen'];

                    if (num === 0) return 'Zero';

                    const crores = Math.floor(num / 10000000);
                    const lakhs = Math.floor((num % 10000000) / 100000);
                    const thousands = Math.floor((num % 100000) / 1000);
                    const hundreds = Math.floor((num % 1000) / 100);
                    const remainder = num % 100;

                    let words = '';

                    if (crores > 0) words += ones[crores] + ' Crore ';
                    if (lakhs > 0) words += (lakhs < 10 ? ones[lakhs] : tens[Math.floor(lakhs / 10)] + ' ' + ones[lakhs % 10]) + ' Lakh ';
                    if (thousands > 0) words += (thousands < 10 ? ones[thousands] : tens[Math.floor(thousands / 10)] + ' ' + ones[thousands % 10]) + ' Thousand ';
                    if (hundreds > 0) words += ones[hundreds] + ' Hundred ';

                    if (remainder >= 20) {
                        words += tens[Math.floor(remainder / 10)] + ' ' + ones[remainder % 10];
                    } else if (remainder >= 10) {
                        words += teens[remainder - 10];
                    } else if (remainder > 0) {
                        words += ones[remainder];
                    }

                    return words.trim();
                }

                const totalInWords = numberToWords(Math.floor(total)) + ' Rupees Only';

                // Calculate tax breakdown for each item
                let itemsHtml = '';
                let srNo = 1;
                let totalQuantity = 0;
                let totalTaxableValue = 0;
                let totalCgstAmount = 0;
                let totalSgstAmount = 0;
                let totalIgstAmount = 0;
                let totalAmount = 0;

                cart.forEach(item => {
                    // Calculate item values
                    const itemTaxableValue = item.quantity * item.unit_price;
                    
                    // Calculate tax amounts based on whether IGST or CGST+SGST
                    let itemCgstAmount = 0;
                    let itemSgstAmount = 0;
                    let itemIgstAmount = 0;
                    
                    if (isIGST) {
                        itemIgstAmount = itemTaxableValue * (igstRate / 100);
                    } else {
                        itemCgstAmount = itemTaxableValue * (cgstRate / 100);
                        itemSgstAmount = itemTaxableValue * (sgstRate / 100);
                    }
                    
                    const itemTotalTax = itemIgstAmount + itemCgstAmount + itemSgstAmount;
                    const itemTotal = itemTaxableValue + itemTotalTax;
                    
                    // Accumulate totals
                    totalQuantity += item.quantity;
                    totalTaxableValue += itemTaxableValue;
                    totalCgstAmount += itemCgstAmount;
                    totalSgstAmount += itemSgstAmount;
                    totalIgstAmount += itemIgstAmount;
                    totalAmount += itemTotal;
                    
                    // Format IMEI display - one per line if multiple
                    let imeiDisplay = '';
                    if (item.imei_numbers && item.imei_numbers.length > 0) {
                        imeiDisplay = '<br><span style="font-size: 9px; color: #333; font-family: monospace;">IMEI: ' + item.imei_numbers.join('<br>IMEI: ') + '</span>';
                    }
                    
                    itemsHtml += `
                        <tr>
                            <td style="text-align: center; padding: 6px 4px; border: 1px solid #000;">${srNo++}</td>
                            <td style="padding: 6px 8px; border: 1px solid #000;">
                                <strong>${item.product_name}</strong>${imeiDisplay}
                            </td>
                            <td style="text-align: center; padding: 6px 4px; border: 1px solid #000;">8517</td>
                            <td style="text-align: center; padding: 6px 4px; border: 1px solid #000;">${item.quantity} NOS</td>
                            <td style="text-align: right; padding: 6px 8px; border: 1px solid #000;">â‚¹${item.unit_price.toFixed(2)}</td>
                            <td style="text-align: right; padding: 6px 8px; border: 1px solid #000;">â‚¹${itemTaxableValue.toFixed(2)}</td>
                            <td style="text-align: center; padding: 6px 4px; border: 1px solid #000;">${isIGST && igstRate > 0 ? igstRate.toFixed(2) : ''}</td>
                            <td style="text-align: right; padding: 6px 8px; border: 1px solid #000;">${itemIgstAmount > 0 ? 'â‚¹' + itemIgstAmount.toFixed(2) : ''}</td>
                            <td style="text-align: right; padding: 6px 8px; font-weight: bold; border: 1px solid #000;">â‚¹${itemTotal.toFixed(2)}</td>
                        </tr>
                    `;
                });

                // Add totals row
                itemsHtml += `
                    <tr style="font-weight: bold; background: #f0f0f0;">
                        <td colspan="3" style="text-align: right; padding: 8px; border: 1px solid #000;">Total</td>
                        <td style="text-align: center; padding: 8px; border: 1px solid #000;">${totalQuantity}</td>
                        <td style="border: 1px solid #000;"></td>
                        <td style="text-align: right; padding: 8px; border: 1px solid #000;">â‚¹${totalTaxableValue.toFixed(2)}</td>
                        <td style="border: 1px solid #000;"></td>
                        <td style="text-align: right; padding: 8px; border: 1px solid #000;">${totalIgstAmount > 0 ? 'â‚¹' + totalIgstAmount.toFixed(2) : ''}</td>
                        <td style="text-align: right; padding: 8px; border: 1px solid #000;">â‚¹${totalAmount.toFixed(2)}</td>
                    </tr>
                `;

                printWindow.document.write(`
                    <!DOCTYPE html>
                    <html>
                    <head>
                        <title>Tax Invoice - ${saleResponse.sale_number}</title>
                        <style>
                            @media print {
                                body { margin: 0; }
                                .no-print { display: none; }
                                @page { margin: 8mm; size: A4; }
                            }
                            * { margin: 0; padding: 0; box-sizing: border-box; }
                            body {
                                font-family: Arial, sans-serif;
                                font-size: 11px;
                                line-height: 1.3;
                                color: #000;
                                max-width: 210mm;
                                margin: 0 auto;
                                padding: 8px;
                                background: #fff;
                            }
                            .header-section {
                                border: 2px solid #000;
                                margin-bottom: 2px;
                            }
                            .top-bar {
                                background: #1e40af;
                                padding: 8px 12px;
                                display: flex;
                                justify-content: space-between;
                                align-items: center;
                                color: white;
                            }
                            .shop-name {
                                font-size: 18px;
                                font-weight: bold;
                                color: #1e40af;
                            }
                            .brand-logos {
                                display: flex;
                                gap: 8px;
                                align-items: center;
                            }
                            .brand-logo {
                                width: 32px;
                                height: 32px;
                                background: white;
                                border-radius: 4px;
                                display: flex;
                                align-items: center;
                                justify-content: center;
                                font-size: 8px;
                                font-weight: bold;
                                border: 1px solid #ddd;
                            }
                            .company-info {
                                padding: 8px 12px;
                                text-align: center;
                                border-bottom: 1px solid #000;
                            }
                            .company-name {
                                font-size: 22px;
                                font-weight: bold;
                                color: #1e40af;
                                margin-bottom: 4px;
                            }
                            .company-address {
                                font-size: 10px;
                                margin-bottom: 2px;
                            }
                            .tagline {
                                font-size: 9px;
                                font-style: italic;
                                padding: 4px;
                                background: #f0f0f0;
                                border-top: 1px solid #ddd;
                            }
                            .invoice-meta {
                                display: flex;
                                border: 2px solid #000;
                                border-top: none;
                                margin-bottom: 2px;
                            }
                            .gstin-box {
                                flex: 1;
                                border-right: 1px solid #000;
                                padding: 6px 8px;
                                background: #f9fafb;
                            }
                            .invoice-title-box {
                                flex: 1;
                                padding: 6px 8px;
                                text-align: center;
                                border-right: 1px solid #000;
                            }
                            .invoice-title {
                                font-size: 16px;
                                font-weight: bold;
                                color: #1e40af;
                            }
                            .original-label {
                                font-size: 9px;
                                font-weight: bold;
                            }
                            .customer-invoice-section {
                                display: flex;
                                border: 2px solid #000;
                                border-top: none;
                                margin-bottom: 2px;
                            }
                            .info-box {
                                flex: 1;
                                padding: 6px 8px;
                            }
                            .info-box.bordered {
                                border-right: 1px solid #000;
                            }
                            .info-header {
                                font-weight: bold;
                                font-size: 10px;
                                margin-bottom: 4px;
                                padding-bottom: 2px;
                                border-bottom: 1px solid #ddd;
                            }
                            .info-row {
                                display: flex;
                                margin-bottom: 2px;
                                font-size: 10px;
                            }
                            .info-label {
                                font-weight: bold;
                                min-width: 80px;
                            }
                            table {
                                width: 100%;
                                border-collapse: collapse;
                                border: 2px solid #000;
                                margin-bottom: 2px;
                            }
                            th {
                                background: #e5e7eb;
                                border: 1px solid #000;
                                padding: 6px 4px;
                                font-size: 10px;
                                font-weight: bold;
                                text-align: center;
                            }
                            td {
                                border: 1px solid #000;
                                font-size: 10px;
                            }
                            .summary-section {
                                display: flex;
                                border: 2px solid #000;
                                border-top: none;
                                margin-bottom: 2px;
                            }
                            .left-section {
                                flex: 1.2;
                                border-right: 1px solid #000;
                            }
                            .right-section {
                                flex: 1;
                            }
                            .amount-words {
                                padding: 8px;
                                border-bottom: 1px solid #000;
                                font-size: 10px;
                            }
                            .amount-words strong {
                                display: block;
                                margin-bottom: 2px;
                            }
                            .bank-section {
                                padding: 8px;
                            }
                            .bank-header {
                                font-weight: bold;
                                font-size: 10px;
                                margin-bottom: 4px;
                            }
                            .bank-qr {
                                display: flex;
                                gap: 12px;
                                align-items: flex-start;
                            }
                            .bank-details {
                                flex: 1;
                                font-size: 10px;
                            }
                            .qr-code {
                                width: 80px;
                                height: 80px;
                                border: 1px solid #000;
                                display: flex;
                                align-items: center;
                                justify-content: center;
                                background: #fff;
                                font-size: 8px;
                                text-align: center;
                            }
                            .totals-box {
                                padding: 8px;
                            }
                            .total-row {
                                display: flex;
                                justify-content: space-between;
                                padding: 3px 0;
                                font-size: 10px;
                            }
                            .total-row.highlight {
                                background: #f0f0f0;
                                padding: 4px 6px;
                                margin: 2px -6px;
                                font-weight: bold;
                            }
                            .total-row.grand {
                                border-top: 2px solid #000;
                                padding-top: 6px;
                                margin-top: 4px;
                                font-size: 11px;
                                font-weight: bold;
                            }
                            .certified-text {
                                padding: 6px 8px;
                                text-align: right;
                                font-size: 9px;
                                border-bottom: 1px solid #000;
                            }
                            .terms-section {
                                border: 2px solid #000;
                                border-top: none;
                                padding: 8px;
                                margin-bottom: 2px;
                            }
                            .terms-title {
                                font-weight: bold;
                                font-size: 10px;
                                margin-bottom: 4px;
                            }
                            .terms-content {
                                font-size: 9px;
                                line-height: 1.4;
                            }
                            .signature-section {
                                text-align: right;
                                padding: 8px;
                                border: 2px solid #000;
                                border-top: none;
                            }
                            .signature-line {
                                margin-top: 40px;
                                padding-top: 4px;
                                border-top: 1px solid #000;
                                display: inline-block;
                                min-width: 180px;
                                text-align: center;
                                font-weight: bold;
                                font-size: 10px;
                            }
                            .print-btn {
                                margin: 20px auto;
                                display: block;
                                padding: 12px 40px;
                                background: #10b981;
                                color: white;
                                border: none;
                                cursor: pointer;
                                font-size: 14px;
                                border-radius: 6px;
                                font-weight: bold;
                                box-shadow: 0 2px 4px rgba(0,0,0,0.1);
                            }
                            .print-btn:hover {
                                background: #059669;
                            }
                        </style>
                    </head>
                    <body>
                        <div class="header-section">
                            <div class="company-info">
                                <div class="company-name">${businessSettings.business_name || 'Shree Mobile Shop'}</div>
                                <div class="company-address">
                                    G-156, Bakers Junction, Vasant Vihar, Tardeo Road, ${businessSettings.city || 'Mumbai'} - ${businessSettings.pincode || '400007'}<br>
                                    Ph: ${businessSettings.phone || '022 2222 3939'}
                                </div>
                            </div>
                            <div class="tagline">
                                Get All Your Desired Smart Phones From Apple To Vivo On Huge Discounts And Easy EMI
                            </div>
                        </div>

                        <div class="invoice-meta">
                            <div class="gstin-box">
                                <strong>GSTIN : </strong>${businessSettings.gstin || '26CORPP3939N1ZA'}
                            </div>
                            <div class="invoice-title-box">
                                <div class="invoice-title">TAX INVOICE</div>
                            </div>
                            <div class="gstin-box" style="border-right: none; text-align: right;">
                                <span class="original-label">ORIGINAL FOR RECIPIENT</span>
                            </div>
                        </div>

                        <div class="customer-invoice-section">
                            <div class="info-box bordered">
                                <div class="info-header">Customer Detail</div>
                                <div class="info-row">
                                    <span class="info-label">Name</span>
                                    <span>${saleData.customer_name || 'Walk-in Customer'}</span>
                                </div>
                                <div class="info-row">
                                    <span class="info-label">Address</span>
                                    <span>${businessSettings.state || 'Gujarat'}</span>
                                </div>
                                <div class="info-row">
                                    <span class="info-label">PHONE</span>
                                    <span>${saleData.customer_phone || '-'}</span>
                                </div>
                                <div class="info-row">
                                    <span class="info-label">GSTIN</span>
                                    <span>-</span>
                                </div>
                                <div class="info-row">
                                    <span class="info-label">Place of Supply</span>
                                    <span>${businessSettings.state || 'Gujarat'} ( ${businessSettings.pincode ? businessSettings.pincode.substring(0, 2) : '24'} )</span>
                                </div>
                            </div>
                            <div class="info-box">
                                <div class="info-row" style="margin-bottom: 8px;">
                                    <span class="info-label">Invoice No.</span>
                                    <span style="font-weight: bold;">${saleResponse.sale_number.replace('POS-', '')}</span>
                                </div>
                                <div class="info-row">
                                    <span class="info-label">Invoice Date</span>
                                    <span>${date.toLocaleDateString('en-GB')}</span>
                                </div>
                            </div>
                        </div>

                        <table style="border-collapse: collapse; width: 100%; border: 2px solid #000;">
                            <thead>
                                <tr style="background: #e5e7eb;">
                                    <th style="width: 40px; padding: 8px 4px; border: 1px solid #000; font-size: 10px; text-align: center;">Sr.<br>No.</th>
                                    <th style="padding: 8px; border: 1px solid #000; font-size: 10px; text-align: center;">Name of Product / Service</th>
                                    <th style="width: 70px; padding: 8px 4px; border: 1px solid #000; font-size: 10px; text-align: center;">HSN / SAC</th>
                                    <th style="width: 60px; padding: 8px 4px; border: 1px solid #000; font-size: 10px; text-align: center;">Qty</th>
                                    <th style="width: 90px; padding: 8px; border: 1px solid #000; font-size: 10px; text-align: center;">Rate</th>
                                    <th style="width: 100px; padding: 8px; border: 1px solid #000; font-size: 10px; text-align: center;">Taxable Value</th>
                                    <th colspan="2" style="width: 140px; padding: 8px; border: 1px solid #000; font-size: 10px; text-align: center;">IGST</th>
                                    <th style="width: 100px; padding: 8px; border: 1px solid #000; font-size: 10px; text-align: center;">Total</th>
                                </tr>
                                <tr style="background: #e5e7eb;">
                                    <th colspan="6" style="border: 1px solid #000;"></th>
                                    <th style="width: 50px; padding: 4px; border: 1px solid #000; font-size: 9px; text-align: center;">%</th>
                                    <th style="width: 90px; padding: 4px; border: 1px solid #000; font-size: 9px; text-align: center;">Amount</th>
                                    <th style="border: 1px solid #000;"></th>
                                </tr>
                            </thead>
                            <tbody>
                                ${itemsHtml}
                            </tbody>
                        </table>

                        <div class="summary-section">
                            <div class="left-section">
                                <div class="amount-words">
                                    <strong>Total in words</strong>
                                    <div style="text-transform: uppercase;">${totalInWords.toUpperCase()}</div>
                                </div>
                                <div class="bank-section">
                                    <div class="bank-header">Bank Details</div>
                                    <div class="bank-qr">
                                        <div class="bank-details">
                                            <div class="info-row">
                                                <span class="info-label">Name</span>
                                                <span>${businessSettings.bank_name || 'ICICI'}</span>
                                            </div>
                                            <div class="info-row">
                                                <span class="info-label">Branch</span>
                                                <span>${businessSettings.bank_branch || 'Surat'}</span>
                                            </div>
                                            <div class="info-row">
                                                <span class="info-label">Acc. Number</span>
                                                <span>${businessSettings.bank_account_number || '271550'}</span>
                                            </div>
                                            <div class="info-row">
                                                <span class="info-label">IFSC</span>
                                                <span>${businessSettings.bank_ifsc || 'ICIC045F'}</span>
                                            </div>
                                            <div class="info-row" style="margin-top: 8px;">
                                                <span class="info-label">UPI ID</span>
                                                <span>ifox@icici</span>
                                            </div>
                                        </div>
                                        <div class="qr-code">
                                            <div style="line-height: 1.2;">
                                                QR Code<br>
                                                <small>Pay using UPI</small>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="right-section">
                                <div class="totals-box">
                                    <div class="total-row highlight">
                                        <span>Taxable Amount</span>
                                        <span>â‚¹${totalTaxableValue.toFixed(2)}</span>
                                    </div>
                                    ${isIGST ? `
                                    <div class="total-row">
                                        <span>Add: IGST ${igstRate.toFixed(2)}%</span>
                                        <span>â‚¹${totalIgstAmount.toFixed(2)}</span>
                                    </div>
                                    ` : `
                                    <div class="total-row">
                                        <span>Add: CGST ${cgstRate.toFixed(2)}%</span>
                                        <span>â‚¹${totalCgstAmount.toFixed(2)}</span>
                                    </div>
                                    <div class="total-row">
                                        <span>Add: SGST ${sgstRate.toFixed(2)}%</span>
                                        <span>â‚¹${totalSgstAmount.toFixed(2)}</span>
                                    </div>
                                    `}
                                    <div class="total-row">
                                        <span>Total Tax</span>
                                        <span>â‚¹${(totalIgstAmount + totalCgstAmount + totalSgstAmount).toFixed(2)}</span>
                                    </div>
                                    <div class="total-row grand" style="background: #f0f0f0; margin: 4px -8px; padding: 6px 8px;">
                                        <span>Total Amount After Tax</span>
                                        <span>â‚¹${totalAmount.toFixed(2)}</span>
                                    </div>
                                </div>
                                <div class="certified-text">
                                    (E & O.E)<br>
                                    Certified that the particulars given above are true and correct.<br>
                                    <strong>For Go GST Bill Demo</strong>
                                </div>
                            </div>
                        </div>

                        <div class="terms-section">
                            <div class="terms-title">Terms and Conditions</div>
                            <div class="terms-content">
                                Subject to Maharashtra Junction.<br>
                                Our Responsibility Ceases as soon as goods leaves our Premises.<br>
                                Goods once sold will not taken back.<br>
                                Delivery Ex-Premises.
                            </div>
                            <div class="signature-section" style="border: none; padding-top: 20px;">
                                <div class="signature-line">Authorised Signatory</div>
                            </div>
                        </div>

                        <button class="print-btn no-print" onclick="window.print();">ðŸ–¨ï¸ Print Invoice</button>
                    </body>
                    </html>
                `);

                printWindow.document.close();

                // Auto-print after a short delay
                setTimeout(() => {
                    printWindow.print();
                }, 500);
            }

            function resetPOS() {
                cart = [];
                updateCart();
                $("#customerName, #customerPhone, #customerEmail").val("");
                $("#discountPercent, #taxPercent").val(0);
                $("#paymentMethod").val("cash");
                $(".transaction-tab").removeClass("active");
                $('.transaction-tab[data-type="sale"]').addClass("active");
                currentTransactionType = "sale";
                $("#productSearch").val("").focus();
                $(".btn-success, .btn-primary").prop("disabled", false);
                $(".btn-success").html(
                    '<i class="bi bi-check-circle-fill"></i> Complete Sale'
                );
            }

            // Customer lookup by phone number
            let customerLookupTimeout;
            let currentLookupRequest = null;

            $("#customerPhone").on("input", function() {
                const phone = $(this).val().trim();

                // Clear previous timeout
                clearTimeout(customerLookupTimeout);

                // Abort any in-flight request to prevent race conditions
                if (currentLookupRequest) {
                    currentLookupRequest.abort();
                    currentLookupRequest = null;
                }

                // Only lookup if phone has at least 10 digits
                if (phone.length >= 10) {
                    customerLookupTimeout = setTimeout(function() {
                        // Call API to lookup customer
                        currentLookupRequest = $.ajax({
                            url: `/api/customers/lookup/${encodeURIComponent(phone)}`,
                            method: 'GET',
                            success: function(customer) {
                                // Verify response matches current phone to prevent race condition
                                const currentPhone = $("#customerPhone").val().trim();
                                if (customer.phone === currentPhone) {
                                    // Auto-fill customer details if found and phone still matches
                                    $("#customerName").val(customer.name);
                                    $("#customerEmail").val(customer.email || '');

                                    // Show visual feedback
                                    $("#customerPhone").css('border-color', '#10b981');
                                    setTimeout(() => {
                                        $("#customerPhone").css('border-color', '');
                                    }, 1000);
                                }
                                currentLookupRequest = null;
                            },
                            error: function(xhr) {
                                // Only clear fields if request wasn't aborted
                                if (xhr.statusText !== 'abort') {
                                    // Verify phone hasn't changed before clearing
                                    const currentPhone = $("#customerPhone").val().trim();
                                    if (currentPhone === phone) {
                                        // Customer not found - clear fields to prevent stale data
                                        $("#customerName").val('');
                                        $("#customerEmail").val('');
                                    }
                                    $("#customerPhone").css('border-color', '');
                                }
                                currentLookupRequest = null;
                            }
                        });
                    }, 500); // Wait 500ms after user stops typing
                } else {
                    // Clear all customer fields if phone is too short
                    $("#customerName").val('');
                    $("#customerEmail").val('');
                    $("#customerPhone").css('border-color', '');
                }
            });

            // Initialize
            $(document).ready(function () {
                $("#productSearch").focus();
                calculateTotals();
            });

            // Keyboard shortcuts
            $(document).on("keydown", function (e) {
                // F9 - Focus search
                if (e.key === "F9") {
                    e.preventDefault();
                    $("#productSearch").focus();
                }

                // F12 - Complete sale
                if (e.key === "F12") {
                    e.preventDefault();
                    completeSale();
                }

                // Esc - Clear search or cart
                if (e.key === "Escape") {
                    if ($("#productSearch").val()) {
                        $("#productSearch").val("");
                        $("#searchResults").empty();
                    } else if (cart.length > 0) {
                        clearCart();
                    }
                }
            });
        </script>
    </body>
</html>